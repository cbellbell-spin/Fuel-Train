<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Fuel & Train — Tracker (Sheets + AI)</title>
<link rel="icon" href="assets/favicon.ico" sizes="any">
<link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32.png">
<link rel="icon" type="image/png" sizes="16x16" href="assets/favicon-16.png">
<link rel="apple-touch-icon" href="assets/apple-touch-icon.png">
<style>
  :root{--bg:#0f172a;--panel:#111827;--soft:#1f2937;--text:#e5e7eb;--muted:#9ca3af;--accent:#22c55e;--accent2:#60a5fa;--warn:#f59e0b;--danger:#ef4444}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:5;background:linear-gradient(to bottom, rgba(15,23,42,0.95), rgba(15,23,42,0.75));backdrop-filter: blur(6px)}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  h1{font-size:22px;margin:0 0 6px 0}
  .sub{color:var(--muted);font-size:13px}
  nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  nav button{background:var(--soft);border:1px solid #1f2937;color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer;font-size:14px}
  nav button.active{border-color:var(--accent);outline:2px solid rgba(34,197,94,0.35)}
  /* nav layout: keep buttons on the left, date on the right */
  #tabs{ display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap; }
  #tabs .tabs-left{ display:flex; gap:8px; flex-wrap:wrap; }
  #tabs .tabs-right input{ width:auto; min-width: 160px; }
  #tabs .tabs-right { display:flex; align-items:center; gap:6px; }
 .date-nav{
  background:var(--soft);
  border:1px solid #253045;
  border-radius:8px;
  padding:6px 10px;
  cursor:pointer;
  color:var(--text);
  line-height:1;
}
.date-nav:focus { outline:2px solid rgba(96,165,250,.35); }
#ui-date{
  padding-right:34px; /* room if your UA shows a calendar icon */
}

  main{padding:16px}
  .panel{background:var(--panel);border:1px solid #1f2937;border-radius:14px;padding:16px;margin-bottom:16px}
  .grid{display:grid;gap:12px}
  .g2{grid-template-columns:repeat(2,1fr)}
  .g3{grid-template-columns:repeat(3,1fr)}
  .g4{grid-template-columns:repeat(4,1fr)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input, select, textarea{width:100%;padding:10px;background:#0b1220;color:var(--text);border:1px solid #1e293b;border-radius:10px}
  textarea{min-height:70px;resize:vertical}
  /* --- Unified Buttons --- */
.btn{
  background: var(--accent);
  color: #fff;                 /* white text for readability */
  border: none;
  padding: 10px 14px;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
  transition: filter .15s ease, transform .02s ease;
}
.btn:hover{ filter: brightness(1.05); }
.btn:active{ transform: translateY(1px); }
.btn:focus-visible{ outline: 2px solid var(--accent2); outline-offset: 2px; }

.btn.small{ padding: 8px 12px; font-size: 14px; }
  
  .stat{background:var(--soft);padding:12px;border-radius:12px;border:1px solid #253045}
  .stat b{font-size:18px;display:block}
  table{width:100%;border-collapse:separate;border-spacing:0;margin-top:8px}
  th, td{padding:10px;border-bottom:1px solid #1f2a40;text-align:left;font-size:14px}
  th{color:#a3b2c2}
  tr:hover td{background:#0b1220}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #263044;font-size:12px;color:#aab6c8}
  .muted{color:var(--muted)}
  .right{justify-content:flex-end}
  .small{font-size:12px}
  .inline-edit{padding:6px 8px;border:1px dashed #334155;border-radius:6px;background:#0b1220}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b1220;border:1px solid #1e293b;border-bottom-width:3px;padding:2px 6px;border-radius:6px}
/* --- Unified Buttons --- */
.btn{
  background: var(--accent);
  color: #fff;                 /* white text for readability */
  border: none;
  padding: 10px 14px;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
  transition: filter .15s ease, transform .02s ease;
}
.btn:hover{ filter: brightness(1.05); }
.btn:active{ transform: translateY(1px); }
.btn:focus-visible{ outline: 2px solid var(--accent2); outline-offset: 2px; }

.btn.small{ padding: 8px 12px; font-size: 14px; }

/* “Quiet” / secondary button */
.btn.secondary{
  background: var(--soft);
  color: #e9eef6;              /* brighter white-ish for contrast */
  border: 1px solid #253045;
}
.btn.secondary:hover{ border-color:#385072; }

/* Danger button (delete) */
.btn.danger{
  background: var(--danger);
  color: #fff;                 /* fix dark text on red */
  border: none;
}

/* Back-compat: make any old .button-quiet look identical to our secondary button */
.button-quiet,
.button-quiet.small{
  background: var(--soft);
  color: #e9eef6;
  border: 1px solid #253045;
  border-radius: 10px;
  font-weight: 700;
  cursor: pointer;
  padding: 10px 14px;
}
.button-quiet.small{ padding: 8px 12px; font-size: 14px; }

/* Phone: let the row wrap (your existing rule kept) */
@media (max-width:720px){
  .inline-row { flex-wrap:wrap; }
  .inline-row .button-quiet { height:auto; }
}
/* Force the Log Food "Lookup with AI" button under the input on mobile */
@media (max-width: 720px) {
  /* Make the inline row wrap and give the text input a full line */
  .inline-row { flex-wrap: wrap; }

  /* The .grow input inside the inline row becomes full width */
  .inline-row .grow {
    flex: 1 1 100%;
    min-width: 0;       /* prevent overflow */
  }

  /* Make the AI button sit on its own line and be easy to tap */
  #f-ai-inline {
    width: 100%;
    margin-top: 6px;
  }
}
@media (max-width: 600px) {
  .grid.g2 {
    grid-template-columns: 1fr; /* stack instead of side by side */
  }
}
/* Mobile layout tweaks for Log Food top row */
@media (max-width: 720px){
  /* Date/Time pair becomes a single column */
  .microgrid-2 { grid-template-columns: 1fr !important; }

  /* Item row: force AI button under the text field */
  .inline-row{
    flex-direction: column;     /* stack vertically on phones */
    align-items: stretch;
  }
  .inline-row .grow{ width: 100%; }
  #f-ai-inline{ width: 100%; margin-top: 8px; }
}
  
.compact-note { margin-top:6px; color:var(--muted); font-size:12px; }
/* Subtle desktop lift for the inline AI button */
#f-ai-inline {
  border: 1px solid #2b3850;
  transition: transform 0.06s ease, box-shadow 0.06s ease, border-color 0.06s ease;
}
#f-ai-inline:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 10px rgba(0,0,0,0.25);
  border-color: #3a4c72;
}
#f-ai-inline:active {
  transform: translateY(0);
  box-shadow: none;
}
/* --- One-row macros (desktop), responsive on smaller screens --- */
.macro-row{
  display: grid;
  grid-template-columns: repeat(4, 1fr); /* 4 across on desktop */
  gap: 8px;
  align-items: end;
}
.macro-row input{
  padding: 8px 10px;      /* slightly tighter than normal inputs */
  font-size: 14px;
  height: 38px;           /* keeps the row visually compact */
}

/* Tablet: 2 per row */
@media (max-width: 900px){
  .macro-row{ grid-template-columns: repeat(2, 1fr); }
}

/* Small phones: 1 per row (still fine) */
@media (max-width: 520px){
  .macro-row{ grid-template-columns: 1fr; }
}
#ui-date-wrap{ margin-left:auto; display:flex; align-items:center; gap:8px }
#ui-date{ background:#0b1220; color:var(--text); border:1px solid #1e293b; border-radius:10px; padding:8px 10px; }
#ui-date-wrap .small { color: var(--muted); font-size: 12px; }
@media (max-width:720px){
  #ui-date-wrap{ width:100%; margin-left:0; justify-content:flex-start; }
}

</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Fuel & Train</h1>
    <div class="sub">Local tracker with optional Google Sheets sync and AI macro lookup. Your data can live in a sheet you control.</div>
    <nav id="tabs"></nav>
  </div>
</header>
<main class="wrap">
  <section id="view-dashboard" class="view"></section>
  <section id="view-food" class="view" style="display:none"></section>
  <section id="view-ex" class="view" style="display:none"></section>
  <section id="view-data" class="view" style="display:none"></section>
  <section id="view-settings" class="view" style="display:none"></section>
  <section id="view-suggest" class="view" style="display:none"></section>
  <section id="view-meals" class="view" style="display:none"></section>
</main>

<script>
const APP_VERSION = '1.3.2';
let SHEETS_ENDPOINT = '';
let OPENAI_KEY = '';
let OPENAI_MODEL = 'gpt-4o-mini';
const $  = (s, r=document)=> r.querySelector(s);
const $$ = (s, r=document)=> Array.from(r.querySelectorAll(s));

  // --- global error banners so crashes are obvious ---
window.addEventListener('error', (e) => {
  const m = (e && e.message) ? e.message : String(e);
  const el = document.createElement('div');
  el.style.cssText = 'position:fixed;left:0;right:0;top:0;z-index:9999;padding:8px 12px;background:#b91c1c;color:#fff;font:12px/1.4 ui-monospace,monospace';
  el.textContent = 'JS Error: ' + m;
  document.body.appendChild(el);
  console.error('JS Error', e);
});
window.addEventListener('unhandledrejection', (e) => {
  const m = (e && e.reason && (e.reason.message || e.reason)) || e;
  const el = document.createElement('div');
  el.style.cssText = 'position:fixed;left:0;right:0;top:0;z-index:9999;padding:8px 12px;background:#92400e;color:#fff;font:12px/1.4 ui-monospace,monospace';
  el.textContent = 'Unhandled Promise Rejection: ' + m;
  document.body.appendChild(el);
  console.error('Unhandled rejection', e);
});

/* ---------- date/time helpers ---------- */
const todayStr = () => {
  const d = new Date();
  d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
  return d.toISOString().slice(0,10);
};

function dateKey(v){
  if (v instanceof Date) {
    const d = new Date(v.getTime() - v.getTimezoneOffset()*60000);
    return d.toISOString().slice(0,10);
  }
  const s = String(v || '').trim();
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;

  const d2 = new Date(s);
  if (!isNaN(d2)) {
    d2.setMinutes(d2.getMinutes() - d2.getTimezoneOffset());
    return d2.toISOString().slice(0,10);
  }
  return todayStr();
}
// add this next to todayStr/dateKey helpers
function addDaysLocal(dateStr, delta) {
  // Force local midnight to avoid UTC parsing quirks
  const d = new Date(String(dateStr || todayStr()) + 'T00:00:00');
  d.setDate(d.getDate() + (delta || 0));
  return dateKey(d);  // your existing normalizer returns YYYY-MM-DD
}
  
function shiftWorkingDate(deltaDays){
  const newDate = addDaysLocal(getWorkingDate(), deltaDays);
  setWorkingDate(newDate);
  rerender();
}

window.addEventListener('keydown', (e)=>{
  if (e.target && ['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
  if (e.key === '[') shiftWorkingDate(-1);
  if (e.key === ']') shiftWorkingDate(+1);
  if (e.key.toLowerCase() === 't') { setWorkingDate(todayStr()); rerender(); }
});

/* --- Global working date (shared across screens) --- */
function getWorkingDate() {
  return state.uiDate || todayStr();
}

function setWorkingDate(d) {
  const next = dateKey(d || todayStr());
  const prev = state.uiDate || '';

  if (next === prev) return;          // nothing to do

  state.uiDate = next;
  saveState();

  // Always keep these in sync
  const ui = $('#ui-date');   if (ui)       ui.value       = next;
  const fFilter = $('#f-filter'); if (fFilter) fFilter.value = next;
  const eFilter = $('#e-filter'); if (eFilter) eFilter.value = next;

  // Only update per-view form dates if the user hasn't changed them away
  const dsDate = $('#ds-date');
  if (dsDate) {
    const cur = dsDate.value ? dateKey(dsDate.value) : '';
    if (!cur || cur === prev) dsDate.value = next;
  }

  const fDate = $('#f-date');
  if (fDate) {
    const cur = fDate.value ? dateKey(fDate.value) : '';
    if (!cur || cur === prev) fDate.value = next;
  }
}

function timeKey(v){
  if (v instanceof Date) {
    const h = String(v.getHours()).padStart(2,'0');
    const m = String(v.getMinutes()).padStart(2,'0');
    return `${h}:${m}`;
  }
  const s = String(v || '').trim();
  if (!s) return '00:00';

  // "9:15 pm"
  let m = s.match(/^(\d{1,2}):?(\d{2})\s*(am|pm)$/i);
  if (m){
    let h = parseInt(m[1],10);
    const mm = m[2];
    const ap = m[3].toLowerCase();
    if (ap==='pm' && h<12) h+=12;
    if (ap==='am' && h===12) h=0;
    return `${String(h).padStart(2,'0')}:${mm}`;
  }
  // "HH:MM" or "HHMM"
  m = s.match(/^(\d{1,2}):?(\d{2})$/);
  if (m){
    const h = String(parseInt(m[1],10)).padStart(2,'0');
    const mm = String(parseInt(m[2],10)).padStart(2,'0');
    return `${h}:${mm}`;
  }
  // "HMM"/"HHMM" compact
  m = s.match(/^(\d{3,4})$/);
  if (m){
    const num = m[1].padStart(4,'0');
    const h = num.slice(0,2);
    const mm = num.slice(2,4);
    return `${h}:${mm}`;
  }
  // ISO-ish or time-only date objects from Sheets
  const d = new Date(s);
  if (!isNaN(d)) {
    const h = String(d.getHours()).padStart(2,'0');
    const mm = String(d.getMinutes()).padStart(2,'0');
    return `${h}:${mm}`;
  }
  return '00:00';
}
const showDate = v => dateKey(v);
const showTime = v => timeKey(v);

const toNum = (v,d=0)=> isNaN(parseFloat(v))? d : parseFloat(v);
const fmt1  = n => (isFinite(n)? Math.round(n): 0);
const uid   = ()=> Math.random().toString(36).slice(2,10)+Date.now().toString(36).slice(-4);
function toast(m){ try{ alert(m); }catch{} }

/* ---------- API ---------- */
async function api(action, payload={}){
  if(!SHEETS_ENDPOINT) throw new Error('No Sheets endpoint configured');
  const res = await fetch(SHEETS_ENDPOINT, {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({action, payload})
  });
  if(!res.ok) throw new Error('Sheets API error '+res.status);
  return res.json();
}

/* ---------- Food Library helpers ---------- */
function norm(s){
  return String(s||'').toLowerCase().replace(/[^a-z0-9\s]/g,' ').replace(/\s+/g,' ').trim();
}
async function findFoodLibrary(q, limit=8){
  const res = await api('foodlib.find', { q, limit });
  if (!res || res.ok === false) return [];
  return res.results || res.rows || [];
}
function renderFoodSuggestions(list){
  const box = document.getElementById('f-suggest');
  if (!box) return;
  if (!list || !list.length){ box.innerHTML = ''; return; }
  box.innerHTML = `
    <div class="panel" style="padding:8px">
      <div class="small muted">Matches in your Food Library</div>
      ${list.map(r=>`
        <div class="row" style="justify-content:space-between;border-top:1px solid #1f2a40;padding:6px 0">
          <div>
            <div><b>${r.name || ''}</b> ${r.brand ? '· '+r.brand : ''}</div>
            <div class="muted small">${r.serving_desc || ''}</div>
          </div>
          <button class="btn small" data-pick="${r.id}">
            ${Math.round(r.calories||0)} kcal · ${Math.round(r.protein||0)}P ${Math.round(r.carbs||0)}C ${Math.round(r.fat||0)}F
          </button>
        </div>
      `).join('')}
    </div>
  `;
  box.querySelectorAll('[data-pick]').forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute('data-pick');
      const r = list.find(x => String(x.id) === String(id));
      if (!r) return;
      $('#f-item').value  = r.name || '';
      $('#f-cal').value   = r.calories || 0;
      $('#f-prot').value  = r.protein  || 0;
      $('#f-carb').value  = r.carbs    || 0;
      $('#f-fat').value   = r.fat      || 0;
      const notesEl = $('#f-notes');
      if (notesEl && r.serving_desc && !notesEl.value) notesEl.value = r.serving_desc;
      renderFoodSuggestions([]);
    };
  });
}

/* ---------- state ---------- */
const defaultState = {
  // Single source of truth for "the working day"
  uiDate: todayStr(),
  foods: [], exercises: [], meals: [],
  // Map of overrides keyed by 'YYYY-MM-DD' -> { activeKcalsOverride, source, updatedAt }
  dailyOverrides: {},
  settings: {
    bodyWeightKg: 81.6, proteinPerKg: 2.0, ree: 1950, actCalFactor: 0.70,
    highDayCarb_g_per_kg: 6.0, modDayCarb_g_per_kg: 4.0, lowDayCarb_g_per_kg: 2.5, fat_g_per_kg: 0.8,
    goal: 'recomp', deficit: 400, glp1: false, dayType: 'moderate',
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || 'local',
    sheetsEndpoint: '', openaiKey: '', openaiModel: 'gpt-4o-mini', dietaryStrategy: 'hexis'
  },
  lastSync: null
};
function loadState(){
  try{
    const raw=localStorage.getItem('ft-app-state-v2');
    if(!raw) return JSON.parse(JSON.stringify(defaultState));
    const s=JSON.parse(raw);
    s.settings=Object.assign({},defaultState.settings,s.settings||{});
    s.foods=s.foods||[]; s.exercises=s.exercises||[]; s.meals=s.meals||[];
    s.dailyOverrides = s.dailyOverrides || {};
    return s;
  }catch{ return JSON.parse(JSON.stringify(defaultState)); }
}
// --- Boot: load state, normalize working date, then render header + first view
let state = loadState();

// normalize working date once
if (!state.uiDate || !/^\d{4}-\d{2}-\d{2}$/.test(state.uiDate)) {
  state.uiDate = todayStr();
  saveState();
}
setWorkingDate(state.uiDate);   // <- does NOT rerender; just updates state + any visible inputs

// env keys (keep as you had)
SHEETS_ENDPOINT = state.settings.sheetsEndpoint || '';
OPENAI_KEY      = state.settings.openaiKey      || '';
OPENAI_MODEL    = state.settings.openaiModel    || 'gpt-4o-mini';

/* ---------- tabs ---------- */
const tabs = [
  {id:'dashboard', label:'Dashboard'},
  {id:'food',      label:'Log Food'},
  {id:'ex',        label:'Log Exercise'},
  {id:'data',      label:'Data & Export'},
  {id:'meals',     label:'Meal Plans'},
  {id:'settings',  label:'Settings'},
  {id:'suggest',   label:'Suggestions'}
];
  
// header + first screen
renderTabs('dashboard');
switchView('dashboard');
function saveState(){ localStorage.setItem('ft-app-state-v2', JSON.stringify(state)); }

function renderTabs(active = 'dashboard') {
  const nav = $('#tabs');
  if (!nav) return;

  // Left: tab buttons
  const left = document.createElement('div');
  left.className = 'tabs-left';
  tabs.forEach(t => {
    const b = document.createElement('button');
    b.textContent = t.label;
    if (t.id === active) b.classList.add('active');
    b.onclick = () => switchView(t.id);
    left.appendChild(b);
  });

  // Right: date controls (prev | date | next)
  const right = document.createElement('div');
  right.className = 'tabs-right';
  right.innerHTML = `
    <button type="button" class="date-nav" id="ui-prev" title="Previous day" aria-label="Previous day">‹</button>
    <input id="ui-date" type="date" value="${getWorkingDate()}" title="Change working date" />
    <button class="date-nav" id="ui-next" title="Next day" aria-label="Next day">›</button>
  `;

  // Mount
  nav.innerHTML = '';
  nav.appendChild(left);
  nav.appendChild(right);

  // Wire (after mount)
  const ui   = $('#ui-date');
  const prev = $('#ui-prev');
  const next = $('#ui-next');

  if (ui) {
    // ensure value reflects current working date
    ui.value = getWorkingDate();
    ui.onchange = () => {
      setWorkingDate(ui.value);
      rerender();
    };
  }
  if (prev) prev.onclick = () => {
    shiftWorkingDate(-1);
    const u = $('#ui-date'); if (u) u.value = getWorkingDate();
  };
  if (next) next.onclick = () => {
    shiftWorkingDate(+1);
    const u = $('#ui-date'); if (u) u.value = getWorkingDate();
  };
}

function switchView(id){
  $$('.view').forEach(v=> v.style.display='none');
  $(`#view-${id}`).style.display='';
  renderTabs(id);
  if(id==='dashboard') renderDashboard();
  if(id==='food')      renderFood();
  if(id==='ex')        renderExercise();
  if(id==='data')      renderData();
  if(id==='settings')  renderSettings();
  if(id==='suggest')   renderSuggest();
  if(id==='meals')     renderMeals();
}

/* ---------- rerender helpers ---------- */
function currentViewId() {
  const v = Array.from(document.querySelectorAll('main .view'))
    .find(s => s.style.display !== 'none');
  return v ? v.id.replace('view-','') : 'dashboard';
}
function rerender() {
  const id = currentViewId();
  if(id==='dashboard') renderDashboard();
  if(id==='food')      renderFood();
  if(id==='ex')        renderExercise();
  if(id==='data')      renderData();
  if(id==='settings')  renderSettings();
  if(id==='suggest')   renderSuggest();
  if(id==='meals')     renderMeals();
}

/* ---------- loading banner ---------- */
function showLoadingBanner(msg){
  const headerWrap = document.querySelector('header .wrap');
  if (!headerWrap) return;
  let el = document.getElementById('ft-loading');
  if (!el) {
    el = document.createElement('div');
    el.id = 'ft-loading';
    el.className = 'panel';
    el.style.marginTop = '10px';
    el.innerHTML = `<div class="small">${msg || 'Loading...'}</div>`;
    headerWrap.appendChild(el);
  } else {
    el.querySelector('.small').textContent = msg || 'Loading...';
  }
}
function hideLoadingBanner(){
  const el = document.getElementById('ft-loading');
  if (el && el.parentNode) el.parentNode.removeChild(el);
}

/* ---------- sync pipeline ---------- */
async function trySync(opts={ refresh:true }) {
  if (!SHEETS_ENDPOINT) {
    return {
      foods: state.foods.length,
      exercises: state.exercises.length,
      meals: state.meals.length,
      daily: Object.keys(state.dailyOverrides||{}).length
    };
  }
  try {
    const res = await api('bootstrap', { version: APP_VERSION });
    const payload = (res && res.result) ? res.result : res;

    // Foods
    if (Array.isArray(payload.foods)) {
      state.foods = payload.foods.map(r => ({
        ...r,
        date: dateKey(r.date),
        time: timeKey(r.time)
      }));
    }

    // Exercises
    if (Array.isArray(payload.exercises)) {
      state.exercises = payload.exercises.map(r => ({
        ...r,
        date: dateKey(r.date),
        time: timeKey(r.time)
      }));
    }

    // Meals (no date/time)
    if (Array.isArray(payload.meals)) {
      state.meals = payload.meals.slice();
    }

    // --- DAILY SUMMARY: array + map mirror ---
    if (Array.isArray(payload.daily)) {
    // Source of truth: array of rows
     state.daily = payload.daily.map(r => ({
    ...r,
    date: dateKey(r.date)  // normalize to 'YYYY-MM-DD'
  }));

  // Back-compat mirror: map by date
  const map = {};
  state.daily.forEach(r => {
    const v = toNum(r.activeKcalsOverride, NaN);
    if (Number.isFinite(v)) {
      map[r.date] = {
        activeKcalsOverride: v,
        source: r.source || 'server',
        updatedAt: r.updatedAt || new Date().toISOString()
      };
    }
  });
  state.dailyOverrides = map;
} else {
  if (!Array.isArray(state.daily)) state.daily = [];
  state.dailyOverrides = state.dailyOverrides || {};
}


    state.lastSync = new Date().toISOString();
    saveState();

    if (opts.refresh) rerender();

    const info = {
      foods: state.foods.length,
      exercises: state.exercises.length,
      meals: state.meals.length,
      daily: Object.keys(state.dailyOverrides||{}).length
    };
    try { toast(`Pulled ${info.foods} foods, ${info.exercises} activities, ${info.meals} meals, ${info.daily} daily overrides`); } catch {}
    return info;
  } catch (e) {
    console.warn('sync failed', e);
    toast('Sync failed: ' + e.message);
    return {
      foods: state.foods.length,
      exercises: state.exercises.length,
      meals: state.meals.length,
      daily: Object.keys(state.dailyOverrides||{}).length
    };
  }
}

async function pushRow(sheet, row){ if(!SHEETS_ENDPOINT) return; try{ await api('upsert',{sheet,row}); }catch(e){ console.warn('pushRow failed', e); } }
async function deleteRow(sheet, id){ if(!SHEETS_ENDPOINT) return; try{ await api('delete',{sheet,id}); }catch(e){ console.warn('deleteRow failed', e); } }

/* ---------- AI lookup (GET to avoid preflight) ---------- */
/* ---------- AI lookup (GET to avoid preflight) ---------- */
async function lookupMacrosWithAI(description){
  if (!SHEETS_ENDPOINT) {
    throw new Error('No backend set. Add your Apps Script/Cloudflare URL in Settings.');
  }
  const url = SHEETS_ENDPOINT + '?action=ai.nutrition&description=' + encodeURIComponent(description || '');
  console.debug('[AI] GET', url);

  const res = await fetch(url, { method: 'GET', cache: 'no-store' });
  const rawText = await res.text();                   // capture text for diagnostics
  console.debug('[AI] status', res.status, rawText);

  if (!res.ok) throw new Error(`Backend HTTP ${res.status}`);

  let data;
  try { data = JSON.parse(rawText); }
  catch { throw new Error('Backend did not return JSON'); }

  // If server wraps result in { ok:false, error } — surface it
  if (data && data.ok === false) {
    throw new Error(data.error || 'Backend returned ok=false');
  }

  // Accept common shapes:
  // {result:{...}} | {...} | [{...}]
  let payload = (data && (data.result ?? data)) ?? null;
  if (Array.isArray(payload)) payload = payload[0] || null;
  if (!payload || typeof payload !== 'object') {
    throw new Error('AI lookup returned no result');
  }

  // parse numbers even if strings like "350 kcal"
  const numish = (v) => {
    if (v === 0) return 0;
    if (v == null) return '';
    const m = String(v).match(/-?\d+(\.\d+)?/);
    return m ? Number(m[0]) : '';
  };

  const out = {
    calories: numish(payload.calories),
    protein:  numish(payload.protein),
    carbs:    numish(payload.carbs),
    fat:      numish(payload.fat)
  };

  // If literally all are blank, treat as failure so user gets a message
  if (out.calories === '' && out.protein === '' && out.carbs === '' && out.fat === '') {
    throw new Error('AI lookup returned no macros');
  }

  console.debug('[AI] parsed', out);
  return out;
}

/* ---------- calculations ---------- */
function correctedActiveCalories(e){
  const factor = toNum(state.settings.actCalFactor,0.7);
  const device = toNum(e.deviceCalories,0);
  if(device>0) return device * factor;
  const durH = toNum(e.durationMin,0)/60;
  const met = {rest:1.2, low:4.0, moderate:7.0, high:10.0}[e.intensity||'moderate'];
  return met * toNum(state.settings.bodyWeightKg,80) * durH;
}
// Prefer daily override when present (number or null)
function getActiveOverride(dateStr) {
  const d = dateKey(dateStr || todayStr());

  // Source of truth: state.daily (array of rows)
  if (Array.isArray(state.daily)) {
    const row = state.daily.find(r => dateKey(r.date) === d);
    const v = row ? toNum(row.activeKcalsOverride, NaN) : NaN;
    return Number.isFinite(v) ? v : null;  // keep 0 as valid
  }

  // Back-compat: map mirror
  const m = state.dailyOverrides && state.dailyOverrides[d];
  if (m && Number.isFinite(+m.activeKcalsOverride)) return +m.activeKcalsOverride;

  return null;
}

// Prefer daily override when present
function getActiveForDate(dateStr){
  const o = getActiveOverride(dateStr);
  if (Number.isFinite(o)) return o;       // honor manual override
  const exs = state.exercises.filter(e => dateKey(e.date) === dateStr);
  return exs.reduce((a,b)=> a + correctedActiveCalories(b), 0);
}

function calcTotals(dateStr){
  const foods = state.foods.filter(f=> f.date===dateStr);
  const calFood = foods.reduce((a,b)=> a+toNum(b.calories),0);
  const p = foods.reduce((a,b)=> a+toNum(b.protein),0);
  const c = foods.reduce((a,b)=> a+toNum(b.carbs),0);
  const f = foods.reduce((a,b)=> a+toNum(b.fat),0);
  const active = getActiveForDate(dateStr);
  return {calFood,p,c,f,active};
}

/* ---------- daily override save/clear ---------- */
async function setDailyOverride(dateStr, kcals, source='manual'){
  if (!dateStr) dateStr = todayStr();
  const row = {
    id: `ds_${dateStr}`,
    date: dateStr,
    activeKcalsOverride: toNum(kcals, 0),
    source,
    updatedAt: new Date().toISOString()
  };
  state.dailyOverrides[dateStr] = {
    activeKcalsOverride: row.activeKcalsOverride,
    source: row.source,
    updatedAt: row.updatedAt
  };
  saveState();
  if (SHEETS_ENDPOINT) {
    try { await api('upsert', { sheet: 'Daily Summary', row }); }
    catch(e){ console.warn('Daily override upsert failed', e); }
  }
}
async function clearDailyOverride(dateStr){
  if (!dateStr) dateStr = todayStr();
  delete (state.dailyOverrides||{})[dateStr];
  saveState();
  if (SHEETS_ENDPOINT) {
    try { await api('delete', { sheet:'Daily Summary', id:`ds_${dateStr}` }); }
    catch(e){ console.warn('Daily override delete failed', e); }
  }
}

/* ---------- macro plan (use override for actToday) ---------- */
function macroPlan(){
  const s=state.settings; const bw=toNum(s.bodyWeightKg,80);
  const protein = Math.max(bw*toNum(s.proteinPerKg,2.0), bw*1.6);
  let ckg=s.modDayCarb_g_per_kg;
  if(s.dayType==='high'){ ckg=s.highDayCarb_g_per_kg; }
  else if(s.dayType==='low'){ ckg=s.lowDayCarb_g_per_kg; }
  else if(s.dayType==='rest'){ ckg=Math.min(2.0,s.lowDayCarb_g_per_kg); }

  const strat = s.dietaryStrategy || 'none';
  if (strat === 'hexis') {
    const exToday = state.exercises.filter(e => e.date === todayStr());
    const hoursByInt = exToday.reduce((acc,e) => {
      const h = toNum(e.durationMin,0)/60;
      let w = 0.0;
      if(e.intensity==='high'){ w = 2.0; }
      else if(e.intensity==='moderate'){ w = 1.5; }
      else if(e.intensity==='low'){ w = 1.0; }
      acc.load += h * w;
      acc.h += h;
      return acc;
    }, {load:0, h:0});
    const load = hoursByInt.load;
    const mapped = 2.0 + Math.min(6.0, load * 2.0);
    const fallbackMap = {high:7.0, moderate:4.5, low:2.5, rest:2.0};
    const fallback = (s.dayType in fallbackMap) ? fallbackMap[s.dayType] : 4.0;
    ckg = Math.max(2.0, Math.min(8.0, (exToday.length ? mapped : fallback)));
  } else if (strat === 'paleo') {
    if(ckg > 3.0){ ckg = 3.0; }
    if(toNum(s.fat_g_per_kg,0.8) < 1.0){ s.fat_g_per_kg = 1.0; }
  } else if (strat === 'keto') {
    const carbsFixed = 30;
    const kcP = protein*4;
    const actToday = getActiveForDate(todayStr());
    const tdee = toNum(s.ree,1950)+actToday;
    let target=tdee;
    if(s.goal==='loss'){ target-=toNum(s.deficit,400); }
    else if(s.goal==='recomp'){ target-=Math.min(toNum(s.deficit,400),300); }
    else if(s.goal==='gain'){ target+=200; }
    const fats = Math.max(bw*toNum(s.fat_g_per_kg,0.8), (target - kcP - carbsFixed*4)/9);
    return { protein, carbs: carbsFixed, fats, kcalsTarget: target, tdee, actToday };
  } else if (strat === 'mediterranean') {
    if(ckg < 3.0){ ckg = 3.0; }
    if(ckg > 5.0){ ckg = 5.0; }
    if(toNum(s.fat_g_per_kg,0.8) < 1.0){ s.fat_g_per_kg = 1.0; }
  }

  const carbs = bw*ckg;
  const fatsMin=bw*toNum(s.fat_g_per_kg,0.8);
  const kcP=protein*4, kcC=carbs*4;
  const actToday = getActiveForDate(todayStr());
  const tdee = toNum(s.ree,1950)+actToday;
  let target=tdee;
  if(s.goal==='loss'){ target-=toNum(s.deficit,400); }
  else if(s.goal==='recomp'){ target-=Math.min(toNum(s.deficit,400),300); }
  else if(s.goal==='gain'){ target+=200; }
  const fats = Math.max(fatsMin, (target-kcP-kcC)/9);
  return {protein, carbs, fats, kcalsTarget: target, tdee, actToday};
}

/* ---------- views ---------- */
function renderDashboard(){
  const el=$('#view-dashboard'); const d=getWorkingDate(); const totals=calcTotals(d);
  const overrideToday = Array.isArray(state.daily)
  && state.daily.some(r => String(r.date) === d && Number.isFinite(+r.activeKcalsOverride));
  const tdee = toNum(state.settings.ree,1950)+totals.active;
  const goal=state.settings.goal; const def=toNum(state.settings.deficit,400);
  let target=tdee;
  if(goal==='loss'){ target=tdee-def; }
  else if(goal==='recomp'){ target=tdee-Math.min(def,300); }
  else if(goal==='gain'){ target=tdee+200; }
  const balance = target - totals.calFood;

  el.innerHTML = `
    <div class="panel">
      <div class="row">
        <div class="stat"><b>${fmt1(totals.calFood)}</b><div class="small muted">Calories eaten</div></div>
        <div class="stat"><b>${fmt1(totals.p)} g</b><div class="small muted">Protein</div></div>
        <div class="stat"><b>${fmt1(totals.c)} g</b><div class="small muted">Carbs</div></div>
        <div class="stat"><b>${fmt1(totals.f)} g</b><div class="small muted">Fat</div></div>
        <div class="stat"><b>${fmt1(totals.active)}</b><div class="small muted">Active (override-aware)</div></div>
        <div class="stat"><b>${fmt1(tdee)}</b><div class="small muted">TDEE est.</div></div>
        <div class="stat"><b>${fmt1(target)}</b><div class="small muted">Target intake</div></div>
        <div class="stat"><b>${fmt1(balance)}</b><div class="small muted">Remaining</div></div>
      </div>
      <div class="small muted">Activity correction factor <span class="kbd">${state.settings.actCalFactor}</span>. Last sync: ${state.lastSync || 'local only'}</div>
    </div>

    <div class="panel">
      <h3 class="small">Quick add food</h3>
      <div class="grid g4">
        <div><label>Food item</label><input id="qa-food" placeholder="Turkey sandwich on sourdough"></div>
        <div><label>Calories</label><input id="qa-cal" type="number"></div>
        <div><label>Protein (g)</label><input id="qa-prot" type="number" step="0.1"></div>
        <div><label>Carbs (g)</label><input id="qa-carb" type="number" step="0.1"></div>
        <div><label>Fat (g)</label><input id="qa-fat" type="number" step="0.1"></div>
        <div class="row">
          <button class="btn" id="qa-ai">Lookup macros with AI</button>
          <span class="small muted">Requires OpenAI key in Settings</span>
        </div>
        <div class="row right">
          <button class="btn" id="qa-add">Add food</button>
          <button class="btn secondary" onclick="switchView('food')">Open Food Log</button>
        </div>
      </div>
    </div>
  `;
  // ---- keep the Food form + table in sync with the global working date ----
const fDate = $('#f-date');
if (fDate) {
  // initialize from global
  fDate.value = getWorkingDate();
  // push changes to global when user edits the form date
  fDate.onchange = () => { setWorkingDate(fDate.value); rerender(); };
}

const fFilter = $('#f-filter');
if (fFilter) {
  // initialize table filter from global
  fFilter.value = getWorkingDate();
  // when filter changes, make it the global working date too
  fFilter.onchange = () => { setWorkingDate(fFilter.value); renderFoodTable(); };
}

// "All" button clears the table filter (doesn't touch the global date)
const fClear = $('#f-clear');
if (fClear) {
  fClear.onclick = () => { $('#f-filter').value = ''; renderFoodTable(); };
}

  $('$('#qa-ai').onclick = async ()=>{
  const btn = $('#qa-ai');
  try{
    const desc = ($('#qa-food').value || '').trim();
    if(!desc){ toast('Enter a food description'); return; }
    const old = btn.textContent; btn.disabled = true; btn.textContent = 'Looking…';

    const r = await lookupMacrosWithAI(desc);
    $('#qa-cal').value  = r.calories;
    $('#qa-prot').value = r.protein;
    $('#qa-carb').value = r.carbs;
    $('#qa-fat').value  = r.fat;

    btn.textContent = old; btn.disabled = false;
  }catch(e){
    btn.disabled = false; btn.textContent = 'Lookup macros with AI';
    toast(e.message || 'AI lookup failed');
  }
};
').onclick = async ()=>{
  try{
    const desc = ($('#qa-food').value || '').trim();
    if(!desc){ toast('Enter a food description'); return; }

    const r = await lookupMacrosWithAI(desc);
    $('#qa-cal').value  = r.calories; 
    $('#qa-prot').value = r.protein;  
    $('#qa-carb').value = r.carbs;    
    $('#qa-fat').value  = r.fat;
  }catch(e){
    toast(e.message || 'AI lookup failed');
  }
};

  $('#qa-add').onclick = ()=>{
    const food={ id:uid(), date:todayStr(), time:new Date().toTimeString().slice(0,5), item:$('#qa-food').value.trim()||'Food',
      calories:toNum($('#qa-cal').value,0), protein:toNum($('#qa-prot').value,0), carbs:toNum($('#qa-carb').value,0), fat:toNum($('#qa-fat').value,0), notes:'' };
    state.foods.push(food); saveState(); if(SHEETS_ENDPOINT) pushRow('Food Log', food); renderDashboard();
  };
}

function renderFood(){
  const el = $('#view-food');
  el.innerHTML = `
    <div class="panel">
      <h3 class="small">Add Food</h3>

      <div class="grid g4" style="row-gap:12px">
        <!-- Date + Time (paired; stacks on small screens via .microgrid-2) -->
        <div class="microgrid-2" style="grid-column: 1 / span 2">
          <div>
            <label>Date</label>
            <input id="f-date" type="date" value="${getWorkingDate()}">
          </div>
          <div>
            <label>Time</label>
            <input id="f-time" type="time" value="${new Date().toTimeString().slice(0,5)}">
          </div>
        </div>

        <!-- Item with inline AI button -->
        <div style="grid-column: 3 / span 2">
          <label>Item</label>
          <div class="inline-row">
            <input id="f-item" class="grow" placeholder="e.g., turkey sandwich on sourdough">
            <button class="btn secondary" id="f-ai-inline" title="Lookup macros with AI">Lookup with AI</button>
          </div>
          <div id="f-suggest" class="compact-note"></div>
        </div>

        <!-- Macros row -->
        <div class="macro-row" style="grid-column: span 4">
          <div>
            <label>Calories</label>
            <input id="f-cal" type="number" inputmode="decimal">
          </div>
          <div>
            <label>Protein (g)</label>
            <input id="f-prot" type="number" step="0.1" inputmode="decimal">
          </div>
          <div>
            <label>Carbs (g)</label>
            <input id="f-carb" type="number" step="0.1" inputmode="decimal">
          </div>
          <div>
            <label>Fat (g)</label>
            <input id="f-fat" type="number" step="0.1" inputmode="decimal">
          </div>
        </div>

        <!-- Notes -->
        <div style="grid-column: span 4">
          <label>Notes</label>
          <textarea id="f-notes" placeholder="Optional: brand, serving size, adjustments…"></textarea>
        </div>

        <!-- Meal plan helpers -->
        <div class="panel" style="margin-top:6px; grid-column: span 4; padding:12px">
          <div class="row" style="gap:8px; align-items:flex-end">
            <div style="flex:1">
              <label>From Meal Plan</label>
              <select id="f-mealpick">
                <option value="">Pick a saved meal…</option>
              </select>
            </div>
            <button class="btn secondary" id="f-meal-apply">Apply to form</button>
            <button class="btn secondary" id="f-meal-add">Add as entry</button>
          </div>
          <div class="small muted" style="margin-top:6px">Apply fills the fields. Add inserts a Food Log row for this meal.</div>
        </div>
      </div>

      <div class="row" style="justify-content:flex-end; gap:8px; margin-top:8px">
        <button class="btn" id="f-add">Add</button>
      </div>
    </div>

    <div class="panel">
      <h3 class="small">Food Entries</h3>
      <div class="row" style="gap:8px">
        <label>Filter date</label>
        <input id="f-filter" type="date" value="${getWorkingDate()}" style="max-width:200px">
        <button class="btn secondary" id="f-clear">All</button>
        <button class="btn secondary" id="f-sync">Sync from Sheets</button>
      </div>
      <div id="f-table"></div>
    </div>
  `;

  // ------- meal plan picker options -------
  const mealSel = $('#f-mealpick');
  if (mealSel) {
    const meals = (state.meals || []).slice().sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    meals.forEach(m=>{
      const opt = document.createElement('option');
      opt.value = m.id;
      opt.textContent = `${m.name || 'Meal'} • ${fmt1(m.calories||0)} kcal · ${fmt1(m.protein||0)}P ${fmt1(m.carbs||0)}C ${fmt1(m.fat||0)}F`;
      mealSel.appendChild(opt);
    });
  }
  const getMealById = id => (state.meals || []).find(m=> String(m.id) === String(id));

  // ------- AI lookup helper -------
  const doAILookup = async ()=>{
  const btn = $('#f-ai-inline');
  try{
    const desc = ($('#f-item').value || '').trim();
    if(!desc){ toast('Enter a food description'); return; }
    const old = btn.textContent; btn.disabled = true; btn.textContent = 'Looking…';

    const r = await lookupMacrosWithAI(desc);
    $('#f-cal').value  = r.calories;
    $('#f-prot').value = r.protein;
    $('#f-carb').value = r.carbs;
    $('#f-fat').value  = r.fat;

    // seed the library if anything was filled
    if (SHEETS_ENDPOINT && (r.calories || r.protein || r.carbs || r.fat)) {
      api('foodlib.upsert', {
        row: { name: desc, calories:r.calories||0, protein:r.protein||0, carbs:r.carbs||0, fat:r.fat||0, source:'ai' }
      }).catch(()=>{});
    }

    btn.textContent = old; btn.disabled = false;
  }catch(e){
    btn.disabled = false; btn.textContent = 'Lookup with AI';
    toast(e.message || 'AI lookup failed');
  }
};

  // ------- null-safe button hookups -------
  const aiBtn      = $('#f-ai-inline');
  const addBtn     = $('#f-add');
  const mealApply  = $('#f-meal-apply');
  const mealAdd    = $('#f-meal-add');
  const clearBtn   = $('#f-clear');
  const syncBtn    = $('#f-sync');
  const filterEl   = $('#f-filter');
  const dateEl     = $('#f-date');

  if (aiBtn) aiBtn.onclick = doAILookup;

  if (mealApply) mealApply.onclick = ()=>{
    const chosen = getMealById($('#f-mealpick')?.value);
    if (!chosen) { toast('Pick a meal'); return; }
    $('#f-item').value = chosen.name || 'Meal';
    $('#f-cal').value  = toNum(chosen.calories,0);
    $('#f-prot').value = toNum(chosen.protein,0);
    $('#f-carb').value = toNum(chosen.carbs,0);
    $('#f-fat').value  = toNum(chosen.fat,0);
    const notesEl = $('#f-notes');
    if (notesEl && chosen.items && !notesEl.value) notesEl.value = chosen.items;
  };

  if (mealAdd) mealAdd.onclick = async ()=>{
    const chosen = getMealById($('#f-mealpick')?.value);
    if (!chosen) { toast('Pick a meal'); return; }
    const row = {
      id: uid(),
      date: (dateEl && dateEl.value) || getWorkingDate(),
      time: $('#f-time')?.value || '00:00',
      item: chosen.name || 'Meal',
      calories: toNum(chosen.calories,0),
      protein: toNum(chosen.protein,0),
      carbs: toNum(chosen.carbs,0),
      fat: toNum(chosen.fat,0),
      notes: chosen.items || ''
    };
    state.foods.push(row); saveState();
    if (SHEETS_ENDPOINT) {
      pushRow('Food Log', row);
      api('foodlib.upsert', { row: {
        name: row.item,
        serving_desc: row.notes || '',
        calories: row.calories, protein: row.protein, carbs: row.carbs, fat: row.fat,
        source: 'meal_plan'
      }}).catch(()=>{});
    }
    renderFood();
  };

  if (addBtn) addBtn.onclick = async ()=>{
    const row = {
      id: uid(),
      date: (dateEl && dateEl.value) || getWorkingDate(),
      time: $('#f-time')?.value || '00:00',
      item: $('#f-item')?.value.trim() || 'Food',
      calories: toNum($('#f-cal')?.value,0),
      protein:  toNum($('#f-prot')?.value,0),
      carbs:    toNum($('#f-carb')?.value,0),
      fat:      toNum($('#f-fat')?.value,0),
      notes:    $('#f-notes')?.value.trim() || ''
    };
    state.foods.push(row); saveState();
    if (SHEETS_ENDPOINT) {
      pushRow('Food Log', row);
      api('foodlib.upsert', { row: {
        name: row.item,
        serving_desc: row.notes || '',
        calories: row.calories, protein: row.protein, carbs: row.carbs, fat: row.fat,
        source: 'food_log'
      }}).catch(()=>{});
    }
    renderFood();
  };

  // Filter + Sync + date sync to global
  if (clearBtn) clearBtn.onclick = ()=> { if (filterEl) filterEl.value=''; renderFoodTable(); };
  if (syncBtn)  syncBtn.onclick  = async ()=> { if (filterEl) filterEl.value=''; await trySync({ refresh:true }); };
  if (filterEl) filterEl.onchange = ()=> { setWorkingDate(filterEl.value); renderFoodTable(); };
  if (dateEl)   { dateEl.value = getWorkingDate(); dateEl.onchange = ()=> { setWorkingDate(dateEl.value); }; }

  // ------- Food Library suggestions (guarded) -------
  const fItem = $('#f-item');
  let suggestTimer = 0;
  if (fItem) {
    fItem.addEventListener('input', () => {
      clearTimeout(suggestTimer);
      const q = fItem.value.trim();
      if (q.length < 2) { renderFoodSuggestions([]); return; }
      suggestTimer = setTimeout(async () => {
        try {
          const hits = await findFoodLibrary(q, 8);
          renderFoodSuggestions(hits);
        } catch {
          renderFoodSuggestions([]);
        }
      }, 160);
    });
  }

  // finally, render table
  renderFoodTable();
}
function renderFoodTable(){
  const container = $('#f-table');
  if (!container) return;

  const filter = ($('#f-filter') && $('#f-filter').value) || '';
  const rows = state.foods.filter(r => !filter || dateKey(r.date) === filter);

  const total = rows.reduce((a,b)=>{
    a.cal += toNum(b.calories);
    a.p   += toNum(b.protein);
    a.c   += toNum(b.carbs);
    a.f   += toNum(b.fat);
    return a;
  }, {cal:0,p:0,c:0,f:0});

  container.innerHTML = `
    <div class="row">
      <span class="pill">Entries: ${rows.length}</span>
      <span class="pill">Calories: ${fmt1(total.cal)}</span>
      <span class="pill">Protein: ${fmt1(total.p)}g</span>
      <span class="pill">Carbs: ${fmt1(total.c)}g</span>
      <span class="pill">Fat: ${fmt1(total.f)}g</span>
    </div>
    <table>
      <thead><tr><th>Date</th><th>Time</th><th>Item</th><th>Cal</th><th>P</th><th>C</th><th>F</th><th>Notes</th><th></th></tr></thead>
      <tbody>
        ${rows.map(r => `
          <tr>
            ${['date','time','item','calories','protein','carbs','fat','notes'].map(k=>{
              let val = r[k] ?? '';
              if (k === 'date') val = showDate(val);
              if (k === 'time') val = showTime(val);
              return `<td contenteditable class="inline-edit" data-id="${r.id}" data-field="${k}">${val}</td>`;
            }).join('')}
            <td><button class="btn danger small" data-del="${r.id}">Del</button></td>
          </tr>`).join('')}
      </tbody>
    </table>
    <div class="small muted">Edit cells to update. Saves on blur. Deletes sync to Sheets if configured.</div>
  `;

  // inline edits
  $$('#f-table [contenteditable]').forEach(cell=>{
    cell.addEventListener('blur', ()=>{
      const id=cell.dataset.id, field=cell.dataset.field;
      const row=state.foods.find(x=> x.id===id); if(!row) return;
      const raw = cell.textContent.trim();
      if (field === 'date') row.date = dateKey(raw);
      else if (field === 'time') row.time = timeKey(raw);
      else if (['calories','protein','carbs','fat'].includes(field)) row[field] = toNum(raw,0);
      else row[field] = raw;
      saveState(); if (SHEETS_ENDPOINT) pushRow('Food Log', row);
      renderFoodTable();
    });
  });

  // deletes
  $$('#f-table [data-del]').forEach(btn=>{
    btn.onclick = ()=>{
      const id=btn.getAttribute('data-del');
      state.foods = state.foods.filter(x=> x.id!==id);
      saveState(); if (SHEETS_ENDPOINT) deleteRow('Food Log', id);
      renderFoodTable();
    };
  });
}

function renderExercise(){
  const el=$('#view-ex');
  el.innerHTML = `
    <div class="panel">
      <h3 class="small">Daily Active Calories (Total)</h3>
      <div class="grid g4">
        <div><label>Date</label><input id="ds-date" type="date" value="${getWorkingDate()}"></div>
        <div>
          <label>Total active kcals for day</label>
          <input id="ds-active" type="number" placeholder="e.g. 850">
          <div class="small muted">Includes exercise + other activity (watch/EPOCH). Update anytime.</div>
        </div>
      </div>
      <div class="row right">
        <button class="btn"           id="ds-save">Save override</button>
        <button class="btn secondary" id="ds-clear">Clear override</button>
      </div>
      <div class="small muted" id="ds-note" style="margin-top:6px"></div>
    </div>

    <div class="panel">
      <h3 class="small">Add Exercise</h3>
      <div class="grid g4">
        <div><label>Date</label><input id="e-date" type="date" value="${getWorkingDate()}"></div>
        <div><label>Type</label>
          <select id="e-type">
            <option>Cycling - Road</option><option>Cycling - MTB</option><option>Cycling - Gravel</option>
            <option>Run</option><option>Walk</option><option>Strength</option><option>Other</option>
          </select>
        </div>
        <div><label>Duration (min)</label><input id="e-dur" type="number"></div>
        <div><label>Intensity</label>
          <select id="e-int"><option value="rest">Rest</option><option value="low">Low</option><option value="moderate" selected>Moderate</option><option value="high">High</option></select>
        </div>
        <div><label>Device calories (kcal)</label><input id="e-dev" type="number"></div>
        <div><label>Avg HR</label><input id="e-hr" type="number"></div>
        <div><label>RPE (1-10)</label><input id="e-rpe" type="number"></div>
        <div><label>Notes</label><input id="e-notes"></div>
      </div>
      <div class="row right"><button class="btn" id="e-add">Add</button></div>
    </div>

    <div class="panel">
      <h3 class="small">Exercise Entries</h3>
      <div class="row">
        <label>Filter date</label>
        <input id="e-filter" type="date" value="${getWorkingDate()}" style="max-width:200px">
        <button class="btn secondary" id="e-clear">All</button>
        <button class="btn secondary" id="e-sync">Sync from Sheets</button>
      </div>
      <div id="e-table"></div>
    </div>
  `;

  // Wire override UI
  const dsDate = $('#ds-date');
  const dsActive = $('#ds-active');
  const dsNote = $('#ds-note');
  function refreshOverrideUI(){
    const d = dsDate.value || todayStr();
    const o = state.dailyOverrides[d];
    if (o) {
      dsActive.value = o.activeKcalsOverride ?? '';
      dsNote.textContent = `Last set ${new Date(o.updatedAt).toLocaleString()} (${o.source||'manual'})`;
    } else {
      dsActive.value = '';
      dsNote.textContent = 'No override set for this date.';
    }
  }
  dsDate.addEventListener('change', refreshOverrideUI);
  $('#ds-save').onclick = async ()=>{
    const d = dsDate.value || todayStr();
    await setDailyOverride(d, toNum(dsActive.value,0), 'manual');
    refreshOverrideUI();
    if ($('#view-dashboard').style.display !== 'none') renderDashboard();
  };
  $('#ds-clear').onclick = async ()=>{
    const d = dsDate.value || todayStr();
    await clearDailyOverride(d);
    refreshOverrideUI();
    if ($('#view-dashboard').style.display !== 'none') renderDashboard();
  };
  refreshOverrideUI();

  // Exercise add + table
  $('#e-add').onclick = ()=>{
    const e={ id:uid(), date:$('#e-date').value||todayStr(), type:$('#e-type').value, durationMin:toNum($('#e-dur').value,0),
      intensity:$('#e-int').value, deviceCalories:toNum($('#e-dev').value,0), avgHR:toNum($('#e-hr').value,0), rpe:toNum($('#e-rpe').value,0), notes:$('#e-notes').value.trim() };
    state.exercises.push(e); saveState(); if(SHEETS_ENDPOINT) pushRow('Activity Log', e); renderExercise();
  };
  $('#e-clear').onclick = ()=>{ $('#e-filter').value=''; renderExerciseTable(); };
  $('#e-sync').onclick = async ()=>{ await trySync({ refresh:true }); };
  $('#e-filter').onchange = renderExerciseTable;
  renderExerciseTable();
}
function renderExerciseTable(){
  const container = $('#e-table');
  if (!container) return;

  // Which date is the table showing?
  const picked = $('#e-filter') ? $('#e-filter').value : '';
  const dateShown = picked ? dateKey(picked) : null;

  // Rows for that date (or all when filter is empty)
  const rows = state.exercises.filter(r => !dateShown || dateKey(r.date) === dateShown);

  // Totals for visible rows
  const totalActive = rows.reduce((a,b)=> a + correctedActiveCalories(b), 0);

  // ---- override badge (uses the filter date or today) ----
  const queryDate = dateShown || getWorkingDate();
  const oVal = getActiveOverride(queryDate);        // number or null
  const hasOverride = Number.isFinite(oVal);        // 0 is valid

  const overrideBadge = hasOverride
    ? `<span class="pill" title="Override in effect for ${queryDate}" style="margin-left:8px">
         Override: ${fmt1(oVal)} kcal
       </span>`
    : '';

  container.innerHTML = `
    <div class="row" style="gap:8px;align-items:center;margin-bottom:6px">
      <span class="pill">Entries: ${rows.length}</span>
      <span class="pill">Corrected active kcals: ${fmt1(totalActive)}</span>
      ${overrideBadge}
    </div>
    <table>
      <thead>
        <tr>
          <th>Date</th><th>Type</th><th>Dur</th><th>Int</th>
          <th>Device kcal</th><th>Avg HR</th><th>RPE</th><th>Notes</th>
          <th>Adj kcal</th><th></th>
        </tr>
      </thead>
      <tbody>
        ${rows.map(r => `
          <tr>
            ${['date','type','durationMin','intensity','deviceCalories','avgHR','rpe','notes'].map(k=>{
              let val = r[k] ?? '';
              if (k === 'date') val = showDate(val);
              return `<td contenteditable class="inline-edit" data-exid="${r.id}" data-field="${k}">${val}</td>`;
            }).join('')}
            <td>${fmt1(correctedActiveCalories(r))}</td>
            <td><button class="btn danger small" data-del="${r.id}">Del</button></td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    <div class="small muted">Edit saves on blur. Activity correction factor applies.</div>
  `;

  // inline edits
  $$('#e-table [contenteditable]').forEach(cell=>{
    cell.addEventListener('blur', ()=>{
      const id=cell.dataset.exid, field=cell.dataset.field;
      const row=state.exercises.find(x=> x.id===id); if(!row) return;
      const raw = cell.textContent.trim();
      if (field === 'date') row.date = dateKey(raw);
      else if (['durationMin','deviceCalories','avgHR','rpe'].includes(field)) row[field] = toNum(raw,0);
      else row[field] = raw;
      saveState();
      if (SHEETS_ENDPOINT) pushRow('Activity Log', row);
      renderExerciseTable();
    });
  });

  // deletes
  $$('#e-table [data-del]').forEach(btn=>{
    btn.onclick = ()=>{
      const id=btn.getAttribute('data-del');
      state.exercises = state.exercises.filter(x=> x.id!==id);
      saveState();
      if (SHEETS_ENDPOINT) deleteRow('Activity Log', id);
      renderExerciseTable();
    };
  });
}

function renderMeals(){
  const el=$('#view-meals');
  el.innerHTML = `
    <div class="panel">
      <h3 class="small">Save a Meal</h3>
      <div class="grid g4">
        <div><label>Name</label><input id="m-name" placeholder="Greek yogurt bowl"></div>
        <div><label>Servings</label><input id="m-serv" type="number" step="0.1" value="1"></div>
        <div><label>Calories</label><input id="m-cal" type="number"></div>
        <div><label>P</label><input id="m-p" type="number" step="0.1"></div>
        <div><label>C</label><input id="m-c" type="number" step="0.1"></div>
        <div><label>F</label><input id="m-f" type="number" step="0.1"></div>
        <div style="grid-column: span 4"><label>Items (JSON or notes)</label><textarea id="m-items" placeholder='[{"item":"yogurt","g":170}] or notes'></textarea></div>
      </div>
      <div class="row"><button class="btn secondary" id="m-ai">AI estimate macros</button><button class="btn" id="m-save">Save meal</button></div>
    </div>
    <div class="panel"><h3 class="small">Meal Library</h3><div id="m-list"></div></div>
  `;
  $('#m-ai').onclick = async ()=>{
    try{
      const name=$('#m-name').value.trim(); if(!name){ toast('Enter a meal name or description'); return; }
      const r=await lookupMacrosWithAI(name);
      $('#m-cal').value=r.calories||''; $('#m-p').value=r.protein||''; $('#m-c').value=r.carbs||''; $('#m-f').value=r.fat||'';
    }catch(e){ toast(e.message); }
  };
  $('#m-save').onclick = ()=>{
    const meal={ id:uid(), name:$('#m-name').value.trim()||'Meal', servings:toNum($('#m-serv').value,1), calories:toNum($('#m-cal').value,0),
      protein:toNum($('#m-p').value,0), carbs:toNum($('#m-c').value,0), fat:toNum($('#m-f').value,0), items:$('#m-items').value.trim() };
    state.meals.push(meal); saveState(); if(SHEETS_ENDPOINT) pushRow('Meal Plans', meal); renderMeals();
  };
  renderMealList();
}
function renderMealList(){
  const el=$('#m-list'); const rows=state.meals;
  el.innerHTML = `
    <table>
      <thead><tr><th>Name</th><th>Servings</th><th>Cal</th><th>P</th><th>C</th><th>F</th><th>Items</th><th></th></tr></thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            ${['name','servings','calories','protein','carbs','fat','items'].map(k=>`<td contenteditable class="inline-edit" data-id="${r.id}" data-field="${k}">${r[k] ?? ''}</td>`).join('')}
            <td><button class="btn danger small" data-del="${r.id}">Del</button></td>
          </tr>`).join('')}
      </tbody>
    </table>
  `;
  $$('#m-list [contenteditable]').forEach(cell=>{
    cell.addEventListener('blur', ()=>{
      const id=cell.dataset.id, field=cell.dataset.field;
      const row=state.meals.find(x=> x.id===id); if(!row) return;
      const numeric=['servings','calories','protein','carbs','fat'].includes(field);
      row[field]=numeric? toNum(cell.textContent.trim(),0): cell.textContent.trim();
      saveState(); if(SHEETS_ENDPOINT) pushRow('Meal Plans', row); renderMealList();
    });
  });
  $$('#m-list [data-del]').forEach(btn=>{
    btn.onclick = ()=>{
      const id=btn.getAttribute('data-del');
      state.meals = state.meals.filter(x=> x.id!==id); saveState();
      if(SHEETS_ENDPOINT) deleteRow('Meal Plans', id);
      renderMealList();
    };
  });
}

function toCSV(rows, headers){
  const h=headers||Object.keys(rows[0]||{});
  const esc=v=>{ if(v==null) return ''; const s=String(v); return /[",\n]/.test(s)? '"'+s.replace(/"/g,'""')+'"' : s; };
  const lines=[h.join(',')]; rows.forEach(r=> lines.push(h.map(k=> esc(r[k])).join(','))); return lines.join('\n');
}
function renderData(){
  const el=$('#view-data');
  const foodsCSV=toCSV(state.foods,['id','date','time','item','calories','protein','carbs','fat','notes']);
  const exCSV=toCSV(state.exercises,['id','date','type','durationMin','intensity','deviceCalories','avgHR','rpe','notes']);
  const mealsCSV=toCSV(state.meals,['id','name','servings','calories','protein','carbs','fat','items']);
  el.innerHTML = `
    <div class="panel">
      <h3 class="small">Export</h3>
      <div class="row">
        <button class="btn" id="exp-food">Food CSV</button>
        <button class="btn" id="exp-ex">Exercise CSV</button>
        <button class="btn" id="exp-meals">Meals CSV</button>
        <button class="btn secondary" id="exp-json">Full JSON</button>
      </div>
    </div>
    <div class="panel">
      <h3 class="small">Import</h3>
      <div class="row">
        <input type="file" id="imp-file" accept=".csv,.json" />
        <select id="imp-target">
          <option value="auto">Auto-detect</option>
          <option value="foods">Foods</option>
          <option value="exercises">Exercises</option>
          <option value="meals">Meals</option>
          <option value="state">Full state (JSON)</option>
        </select>
        <button class="btn" id="imp-run">Import</button>
      </div>
    </div>
  `;
  function download(name,text){ const a=document.createElement('a'); a.href='data:text/plain;charset=utf-8,'+encodeURIComponent(text); a.download=name; a.style.display='none'; document.body.appendChild(a); a.click(); a.remove(); }
  $('#exp-food').onclick = ()=> download(`foods_${todayStr()}.csv`, foodsCSV);
  $('#exp-ex').onclick   = ()=> download(`exercises_${todayStr()}.csv`, exCSV);
  $('#exp-meals').onclick= ()=> download(`meals_${todayStr()}.csv`, mealsCSV);
  $('#exp-json').onclick = ()=> download(`ft_backup_${Date.now()}.json`, JSON.stringify(state,null,2));

  $('#imp-run').onclick = ()=>{
    const file=$('#imp-file').files[0]; if(!file){ toast('Choose a file'); return; }
    const reader=new FileReader();
    reader.onload=()=>{
      const text=reader.result; const target=$('#imp-target').value;
      try{
        if(file.name.endsWith('.json') || target==='state'){
          const obj=JSON.parse(text); state=Object.assign({},state,obj); saveState(); toast('Imported JSON'); location.reload(); return;
        }
        const lines=text.split(/\r?\n/).filter(Boolean); const headers=lines.shift().split(',');
        const parseRow=line=>{
          const cells=[]; let cur='',q=false;
          for(let i=0;i<line.length;i++){
            const ch=line[i];
            if(q){
              if(ch==='\"' && line[i+1]==='\"'){cur+='\"';i++;}
              else if(ch==='\"'){q=false;} else {cur+=ch;}
            } else {
              if(ch===','){cells.push(cur);cur='';}
              else if(ch==='\"'){q=true;} else {cur+=ch;}
            }
          }
          cells.push(cur);
          const obj={}; headers.forEach((h,idx)=> obj[h]=cells[idx]??''); return obj;
        };
        const rows = lines.map(parseRow);
        if(target==='foods' || (target==='auto' && headers.includes('item') && headers.includes('calories'))){
          state.foods = rows.map(r=>({id:r.id||uid(),date:r.date||todayStr(),time:r.time||'00:00',item:r.item||'',calories:toNum(r.calories,0),protein:toNum(r.protein,0),carbs:toNum(r.carbs,0),fat:toNum(r.fat,0),notes:r.notes||''}));
        } else if(target==='exercises' || (target==='auto' && headers.includes('durationMin') && headers.includes('intensity'))){
          state.exercises = rows.map(r=>({id:r.id||uid(),date:r.date||todayStr(),type:r.type||'Other',durationMin:toNum(r.durationMin,0),intensity:toNum(r.intensity,0)||r.intensity||'moderate',deviceCalories:toNum(r.deviceCalories,0),avgHR:toNum(r.avgHR,0),rpe:toNum(r.rpe,0),notes:r.notes||''}));
        } else if(target==='meals' || (target==='auto' && headers.includes('servings') && headers.includes('calories') && headers.includes('name'))){
          state.meals = rows.map(r=>({id:r.id||uid(),name:r.name||'Meal',servings:toNum(r.servings,1),calories:toNum(r.calories,0),protein:toNum(r.protein,0),carbs:toNum(r.carbs,0),fat:toNum(r.fat,0),items:r.items||''}));
        } else { toast('CSV not recognized'); return; }
        saveState(); toast('Imported'); location.reload();
      }catch(e){ toast('Import failed '+e.message); }
    };
    reader.readAsText(file);
  };
}

function renderSettings(){
  const s=state.settings; const el=$('#view-settings');
  el.innerHTML = `
    <div class="panel">
      <h3 class="small">Core Settings</h3>
      <div class="grid g4">
        <div><label>Body weight (kg)</label><input id="s-bw" type="number" step="0.1" value="${s.bodyWeightKg}"></div>
        <div><label>Protein target (g/kg)</label><input id="s-ppk" type="number" step="0.1" value="${s.proteinPerKg}"></div>
        <div><label>REE (kcal)</label><input id="s-ree" type="number" value="${s.ree}"></div>
        <div><label>Activity correction factor</label><input id="s-fact" type="number" step="0.01" value="${s.actCalFactor}"></div>
        <div><label>Day type</label>
          <select id="s-day">
            <option value="rest" ${s.dayType==='rest'?'selected':''}>Rest</option>
            <option value="low" ${s.dayType==='low'?'selected':''}>Low</option>
            <option value="moderate" ${s.dayType==='moderate'?'selected':''}>Moderate</option>
            <option value="high" ${s.dayType==='high'?'selected':''}>High</option>
          </select>
        </div>
        <div><label>Goal</label>
          <select id="s-goal">
            <option value="loss" ${s.goal==='loss'?'selected':''}>Fat loss</option>
            <option value="maintain" ${s.goal==='maintain'?'selected':''}>Maintain</option>
            <option value="gain" ${s.goal==='gain'?'selected':''}>Gain</option>
            <option value="recomp" ${s.goal==='recomp'?'selected':''}>Recomp</option>
          </select>
        </div>
        <div><label>Deficit when loss/recomp</label><input id="s-def" type="number" value="${s.deficit}"></div>
        <div><label>GLP-1 user</label>
          <select id="s-glp1"><option value="false" ${!s.glp1?'selected':''}>No</option><option value="true" ${s.glp1?'selected':''}>Yes</option></select>
        </div>
      </div>
    </div>
    <div class="panel">
      <h3 class="small">Diet Strategy</h3>
      <div class="grid g4">
        <div>
          <label>Strategy</label>
          <select id="s-strategy">
            <option value="none" ${s.dietaryStrategy==='none'?'selected':''}>None</option>
            <option value="hexis" ${s.dietaryStrategy==='hexis'?'selected':''}>Hexis (carb periodization)</option>
            <option value="paleo" ${s.dietaryStrategy==='paleo'?'selected':''}>Paleo</option>
            <option value="keto" ${s.dietaryStrategy==='keto'?'selected':''}>Keto</option>
            <option value="mediterranean" ${s.dietaryStrategy==='mediterranean'?'selected':''}>Mediterranean</option>
          </select>
        </div>
        <div style="grid-column: span 3">
          <div class="small muted">Hexis uses today’s training load to set carbs per kg. Others adjust ranges accordingly.</div>
        </div>
      </div>
    </div>
    <div class="panel">
      <h3 class="small">Integrations</h3>
      <div class="grid g4">
        <div style="grid-column: span 2"><label>Google Sheets Web App URL</label><input id="s-sheet" placeholder="https://script.google.com/macros/s/.../exec" value="${s.sheetsEndpoint||''}"></div>
        <div><label>OpenAI API Key</label><input id="s-openai" placeholder="sk-..." value="${s.openaiKey||''}"></div>
        <div><label>OpenAI Model</label><input id="s-model" value="${s.openaiModel||OPENAI_MODEL}"></div>
      </div>
      <div class="row right"><button class="btn" id="s-save">Save settings</button><button class="btn secondary" id="s-sync">Pull from Sheets</button></div>
      <div class="small muted">Paste your Apps Script Web App URL to sync. Paste your OpenAI key to enable AI macro lookup.</div>
    </div>
  `;
  $('#s-save').onclick = ()=>{
    s.bodyWeightKg=toNum($('#s-bw').value,s.bodyWeightKg);
    s.proteinPerKg=toNum($('#s-ppk').value,s.proteinPerKg);
    s.ree=toNum($('#s-ree').value,s.ree);
    s.actCalFactor=toNum($('#s-fact').value,s.actCalFactor);
    s.dayType=$('#s-day').value; s.goal=$('#s-goal').value;
    s.deficit=toNum($('#s-def').value,s.deficit);
    s.glp1=$('#s-glp1').value==='true';
    s.dietaryStrategy=$('#s-strategy')? $('#s-strategy').value : (s.dietaryStrategy||'none');
    s.sheetsEndpoint=$('#s-sheet').value.trim(); s.openaiKey=$('#s-openai').value.trim();
    s.openaiModel=$('#s-model').value.trim()||'gpt-4o-mini';
    SHEETS_ENDPOINT=s.sheetsEndpoint; OPENAI_KEY=s.openaiKey; OPENAI_MODEL=s.openaiModel;
    saveState(); toast('Saved');
  };
  $('#s-sync').onclick = async ()=>{ await trySync({ refresh:true }); };
}

function renderSuggest(){
  const el=$('#view-suggest'); const mp=macroPlan();
  const strat = (state.settings && state.settings.dietaryStrategy) || 'none';
  let stratNote = '';
  if(strat==='hexis'){ stratNote='Hexis preset active: carbs scale with today’s training load.'; }
  else if(strat==='paleo'){ stratNote='Paleo preset active: carbs moderated, fats slightly higher.'; }
  else if(strat==='keto'){ stratNote='Keto preset active: ~30 g carbs per day; fats fill remaining calories.'; }
  else if(strat==='mediterranean'){ stratNote='Mediterranean preset active: balanced carbs and fats.'; }

  let hexLine = '';
  if(strat==='hexis'){
    const targetC = Math.max(0, mp.carbs || 0);
    const pre = Math.round(targetC * 0.25);
    const during = Math.round(targetC * 0.35);
    const post = Math.round(targetC * 0.15);
    const rest = Math.max(0, targetC - pre - during - post);
    hexLine = '<li><b>Hexis split:</b> Pre ~' + pre + ' g • During ~' + during + ' g • Post ~' + post + ' g • Rest of day ~' + rest + ' g</li>';
  }

  const eaten=state.foods.filter(f=> f.date===todayStr()).reduce((a,f)=>{a.kcal+=toNum(f.calories,0);a.p+=toNum(f.protein,0);a.c+=toNum(f.carbs,0);a.f+=toNum(f.fat,0);return a;},{kcal:0,p:0,c:0,f:0});
  const left = {kcal: mp.kcalsTarget - eaten.kcal, p: mp.protein - eaten.p, c: mp.carbs - eaten.c, f: mp.fats - eaten.f};
  const dt=state.settings.dayType;
  let timing=[];
  if(dt==='high'){ timing=["Pre 2–3 h: 1–1.5 g/kg carbs + lean protein, low fat","During: 60–90 g carbs/h if >90 min, sodium 500–800 mg/h","Post 0–2 h: 0.6–1.0 g/kg carbs + 30–50 g protein"]; }
  else if(dt==='moderate'){ timing=["Pre 1–2 h: ~0.8 g/kg carbs + 25–35 g protein","During: 30–60 g carbs/h if >60 min","Post: 0.4–0.8 g/kg carbs + 30–40 g protein"]; }
  else { timing=["Protein-forward meals","Place most carbs around training","Hydrate and salt as needed"]; }

  const glp1Tips = state.settings.glp1? ["Smaller, more frequent meals","Front-load protein earlier in day","Hydrate on waking before first food","Keep ultra-fatty foods moderate if nausea-prone"] : [];

  el.innerHTML = `
    <div class="panel">
      <div class="row">
        <div class="stat"><b>${fmt1(mp.kcalsTarget)}</b><div class="small muted">Target kcal</div></div>
        <div class="stat"><b>${fmt1(mp.protein)} g</b><div class="small muted">Protein</div></div>
        <div class="stat"><b>${fmt1(mp.carbs)} g</b><div class="small muted">Carbs (${state.settings.dayType})</div></div>
        <div class="stat"><b>${fmt1(mp.fats)} g</b><div class="small muted">Fat</div></div>
      </div>
      <div class="row"><div class="pill">Eaten: ${fmt1(eaten.kcal)} kcal, ${fmt1(eaten.p)}P/${fmt1(eaten.c)}C/${fmt1(eaten.f)}F</div><div class="pill">Remaining: ${fmt1(left.kcal)} kcal, ${fmt1(left.p)}P/${fmt1(left.c)}C/${fmt1(left.f)}F</div></div>
    </div>
    <div class="panel">
      <h3 class="small">Actionable suggestions</h3>
      <ul class="small">
        <li><b>Strategy:</b> ${stratNote}</li>
        ${hexLine}
        <li><b>Fueling timing:</b> ${timing.join(' • ')}</li>
        <li><b>Protein floor:</b> close ${fmt1(mp.protein)} g by dinner. Add a 30–40 g protein snack if behind.</li>
        ${state.settings.glp1 ? `<li><b>GLP-1 adjustments:</b> ${glp1Tips.join(' • ')}</li>` : ''}
        <li><b>Electrolytes:</b> 500–800 mg sodium per hour in heat or heavy sweat.</li>
      </ul>
    </div>
  `;
}

/* ---------- boot: render, then first-load sync ---------- */
try {
  renderTabs();
  switchView('dashboard');
} catch (err) {
  console.error('Boot failed:', err);
}
const SYNC_MAX_AGE_MS = 6 * 60 * 60 * 1000; // 6 hours

function shouldSyncOnBoot() {
  if (!SHEETS_ENDPOINT) return false;

  // if endpoint changed since last run, force a pull
  const lastEndpoint = localStorage.getItem('ft-last-endpoint') || '';
  if (lastEndpoint !== SHEETS_ENDPOINT) return true;

  // if we've never synced on this device
  if (!state.lastSync) return true;

  // if local caches are empty-ish
  const counts = {
    foods: state.foods?.length || 0,
    exercises: state.exercises?.length || 0,
    meals: state.meals?.length || 0,
    daily: Object.keys(state.dailyOverrides || {}).length
  };
  const empty = (counts.foods + counts.exercises + counts.meals + counts.daily) === 0;
  if (empty) return true;

  // if last sync is stale
  const age = Date.now() - Date.parse(state.lastSync);
  return isFinite(age) && age > SYNC_MAX_AGE_MS;
}

// ----- boot: render, then conditional first-load sync -----
(async function firstLoadSync(){
  if (!SHEETS_ENDPOINT) return;

  try {
    if (!shouldSyncOnBoot()) return;

    showLoadingBanner('Pulling data from Sheets…');
    const info = await trySync({ refresh: true }); // uses your existing pipeline
    // record endpoint for next boot
    localStorage.setItem('ft-last-endpoint', SHEETS_ENDPOINT);
    // state.lastSync is already set inside trySync()
    console.log('Boot sync complete:', info);
  } catch (e) {
    console.warn('Initial sync failed', e);
    // non-fatal; UI still works from local cache
  } finally {
    hideLoadingBanner();
  }
})();

</script>
</body>
</html>
