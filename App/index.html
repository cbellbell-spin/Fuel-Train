/** ============================================================================
 * Fuel & Train Sheets Backend - CLEAN
 * Tabs expected:
 *  - Food Log:     id,date,time,item,calories,protein,carbs,fat,notes
 *  - Activity Log: id,date,type,durationMin,intensity,deviceCalories,avgHR,rpe,notes
 *  - Meal Plans:   id,name,servings,calories,protein,carbs,fat,items
 *  - Food Library: id,key,name,brand,serving_desc,calories,protein,carbs,fat,source,last_used,uses
 *  - Settings:     key,value
 *
 * Setup:
 * 1) Project Settings -> Script properties:
 *      OPENAI_API_KEY = sk-...
 * 2) Deploy -> Manage deployments -> Web app
 *      Execute as: Me
 *      Who has access: Anyone (or Anyone with link)
 * 3) Use the /exec URL
 * ============================================================================ */

// ---------- HTTP ----------
function doGet(e) {
  try {
    var action = (e && e.parameter && e.parameter.action) ? String(e.parameter.action) : '';
    if (action === 'ai.nutrition') {
      var desc = (e.parameter && e.parameter.description) ? String(e.parameter.description) : '';
      return json_({ ok: true, result: aiNutrition_(desc) });
    }
    return json_({ ok: true, ts: new Date().toISOString() });
  } catch (err) {
    return json_({ ok: false, error: String(err) });
  }
}

function doPost(e) {
  try {
    var action = (e.parameter && e.parameter.action) || '';
    var payload = {};
    if (e.postData && e.postData.contents) {
      try { var body = JSON.parse(e.postData.contents); action = action || body.action || ''; payload = body.payload || {}; }
      catch (_) { payload = { sheet:(e.parameter && e.parameter.sheet)||'', row:(e.parameter && e.parameter.row)||'', id:(e.parameter && e.parameter.id)||'' }; }
    }

    if (action === 'bootstrap') {
      return json_({
        ok: true,
        foods: readRows_('Food Log'),
        exercises: readRows_('Activity Log'),
        meals: readRows_('Meal Plans'),
        settingsKV: readSettings_()
      });
    }
    if (action === 'upsert') { upsertRow_(payload.sheet, payload.row); return json_({ ok: true }); }
    if (action === 'delete') { deleteById_(payload.sheet, payload.id); return json_({ ok: true }); }
    if (action === 'list')   { return json_({ ok: true, rows: readRows_(payload.sheet) }); }
    if (action === 'settings.get') { return json_({ ok: true, settings: readSettings_() }); }
    if (action === 'settings.set') { setSettings_(payload.kv || {}); return json_({ ok: true }); }

    if (action === 'foodlib.find') { return json_({ ok: true, results: foodLibFind_(payload.q || '', payload.limit || 8) }); }
    if (action === 'foodlib.upsert'){ return json_({ ok: true, row: foodLibUpsert_(payload.row || {}) }); }

    return json_({ ok:false, error:'Unknown action: ' + action });
  } catch (err) {
    return json_({ ok:false, error:String(err) });
  }
}

// ---------- AI ----------
function aiNutrition_(description) {
  var key = PropertiesService.getScriptProperties().getProperty('OPENAI_API_KEY');
  if (!key) throw new Error('Missing OPENAI_API_KEY in Script properties');

  var url = 'https://api.openai.com/v1/chat/completions';
  var payload = {
    model: 'gpt-4o-mini',
    response_format: { type: 'json_object' },
    messages: [
      { role: 'system', content: 'Return strict JSON with fields: calories, protein_g, carbs_g, fat_g. Units: kcal and grams.' },
      { role: 'user', content: 'Food: ' + String(description || '').slice(0, 500) }
    ],
    temperature: 0
  };

  var res = UrlFetchApp.fetch(url, {
    method: 'post',
    muteHttpExceptions: true,
    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + key },
    payload: JSON.stringify(payload)
  });

  if (res.getResponseCode() !== 200) throw new Error('OpenAI error ' + res.getResponseCode() + ': ' + res.getContentText());
  var data = JSON.parse(res.getContentText());
  var txt = data.choices[0].message.content;
  var obj = JSON.parse(txt);

  return { calories: num_(obj.calories), protein: num_(obj.protein_g), carbs: num_(obj.carbs_g), fat: num_(obj.fat_g) };
}

// ---------- Sheet utils ----------
function ss_(){ return SpreadsheetApp.getActiveSpreadsheet(); }
function json_(o){ return ContentService.createTextOutput(JSON.stringify(o)).setMimeType(ContentService.MimeType.JSON); }
function num_(v){ if (v===null || v===undefined || v==='') return 0; var m=String(v).match(/-?\d+(\.\d+)?/); return m? parseFloat(m[0]) : 0; }

function getOrCreateSheet_(name, headers){
  var ss = ss_(); var sh = ss.getSheetByName(name);
  if(!sh){ sh = ss.insertSheet(name); }
  var first = sh.getRange(1,1,1,sh.getMaxColumns()).getValues()[0].filter(String);
  if(headers && first.length===0){ sh.getRange(1,1,1,headers.length).setValues([headers]); }
  return sh;
}
function ensureHeaders_(name, headers){
  var sh = getOrCreateSheet_(name, headers);
  var existing = sh.getRange(1,1,1,sh.getMaxColumns()).getValues()[0].filter(String);
  if(headers && existing.length < headers.length){
    sh.getRange(1, existing.length+1, 1, headers.length-existing.length).setValues([headers.slice(existing.length)]);
  }
  return sh;
}
function readRows_(name){
  var headersMap = {
    'Food Log':     ['id','date','time','item','calories','protein','carbs','fat','notes'],
    'Activity Log': ['id','date','type','durationMin','intensity','deviceCalories','avgHR','rpe','notes'],
    'Meal Plans':   ['id','name','servings','calories','protein','carbs','fat','items'],
    'Food Library': ['id','key','name','brand','serving_desc','calories','protein','carbs','fat','source','last_used','uses']
  };
  var headers = headersMap[name] || null;
  var sh = ensureHeaders_(name, headers);
  var lastRow = sh.getLastRow();
  if(lastRow < 2) return [];
  var lastCol = sh.getLastColumn();
  var data = sh.getRange(1,1,lastRow,lastCol).getValues();
  var head = data[0];
  var rows = [];
  for(var i=1;i<data.length;i++){
    var row = data[i];
    if(row.filter(String).length===0) continue;
    var obj = {};
    for(var j=0;j<head.length;j++){ obj[head[j]] = row[j]; }
    rows.push(obj);
  }
  return rows;
}
function upsertRow_(name, row){
  if (!row || !row.id) throw new Error('upsert requires row.id');
  var rows = readRows_(name);
  var headers = Object.keys(rows[0] || row);
  var sh = ensureHeaders_(name, headers);
  var head = sh.getRange(1,1,1,sh.getLastColumn()).getValues()[0];
  if (head.indexOf('id') < 0) { head.push('id'); sh.getRange(1,1,1,head.length).setValues([head]); }
  var idCol = head.indexOf('id') + 1;
  var lastRow = sh.getLastRow();
  var idMap = {};
  if (lastRow >= 2) {
    var ids = sh.getRange(2, idCol, lastRow-1, 1).getValues().flat();
    for (var i=0;i<ids.length;i++) idMap[String(ids[i])] = i+2;
  }
  var rowArr = new Array(head.length).fill('');
  for (var k in row){ var idx = head.indexOf(k); if (idx>=0) rowArr[idx] = row[k]; }
  var target = idMap[String(row.id)];
  if (target) sh.getRange(target,1,1,head.length).setValues([rowArr]); else sh.appendRow(rowArr);
}
function deleteById_(name, id){
  var sh = getOrCreateSheet_(name);
  var head = sh.getRange(1,1,1,sh.getLastColumn()).getValues()[0];
  var idIdx = head.indexOf('id'); if (idIdx < 0) return;
  var lastRow = sh.getLastRow(); if (lastRow < 2) return;
  var ids = sh.getRange(2, idIdx+1, lastRow-1, 1).getValues();
  for (var i=0;i<ids.length;i++){ if (String(ids[i][0]) === String(id)) { sh.deleteRow(i+2); return; } }
}
function readSettings_(){
  var sh = ensureHeaders_('Settings', ['key','value']);
  var last = sh.getLastRow(); var kv = {}; if (last < 2) return kv;
  var data = sh.getRange(2,1,last-1,2).getValues();
  for (var i=0;i<data.length;i++) kv[String(data[i][0])] = data[i][1];
  return kv;
}
function setSettings_(kv){
  var sh = ensureHeaders_('Settings', ['key','value']);
  var existing = readSettings_();
  for (var k in kv) existing[k] = kv[k];
  var rows = []; for (var key in existing) rows.push([key, existing[key]]);
  if (sh.getLastRow() > 1) sh.getRange(2,1,sh.getLastRow()-1,2).clearContent();
  if (rows.length) sh.getRange(2,1,rows.length,2).setValues(rows);
}

// ---------- Food Library helpers ----------
function norm_(s){ return String(s || '').toLowerCase().replace(/[^a-z0-9\s]/g,' ').replace(/\s+/g,' ').trim(); }
function todayStr_(){ return new Date().toISOString().slice(0,10); }
function ensureFoodLib_(){
  return ensureHeaders_('Food Library',
    ['id','key','name','brand','serving_desc','calories','protein','carbs','fat','source','last_used','uses']
  );
}
function foodKey_(name, brand, serving){
  return norm_(name) + '|' + norm_(brand) + '|' + norm_(serving);
}
function normalizeFoodRow_(r){
  return {
    id: r.id || r.key || '',
    key: r.key || (r.id || ''),
    name: r.name || '',
    brand: r.brand || '',
    serving_desc: r.serving_desc || r.serving || '',
    calories: num_(r.calories || r.kcal),
    protein:  num_(r.protein  || r.protein_g || r.protien),
    carbs:    num_(r.carbs    || r.carb_g),
    fat:      num_(r.fat      || r.fat_g),
    source: r.source || '',
    last_used: r.last_used || '',
    uses: num_(r.uses)
  };
}
function foodLibFind_(q, limit){
  ensureFoodLib_();
  var rows = readRows_('Food Library');
  var qq = norm_(q);
  var scored = [];
  for (var i=0;i<rows.length;i++){
    var r = rows[i];
    var hay = norm_((r.name||'') + ' ' + (r.brand||'') + ' ' + (r.serving_desc||''));
    var s = 0; if (!qq) continue;
    if (hay.startsWith(qq)) s += 100;
    if (hay.indexOf(qq) >= 0) s += 20;
    s += Math.min(50, num_(r.uses));
    if (r.last_used) s += 5;
    if (s > 0) scored.push({s:s, row:r});
  }
  scored.sort(function(a,b){ return b.s - a.s; });
  var out = [];
  for (var j=0; j<Math.min(limit || 8, scored.length); j++) out.push(normalizeFoodRow_(scored[j].row));
  return out;
}
function foodLibUpsert_(row){
  ensureFoodLib_();
  var name = row.name || row.item || '';
  var brand = row.brand || '';
  var serving = row.serving_desc || row.serving || '';
  var key = foodKey_(name, brand, serving);

  var lib = readRows_('Food Library');
  var byKey = {}; for (var i=0;i<lib.length;i++){ byKey[String(lib[i].key)] = lib[i]; }
  var existing = byKey[key];
  var uses = existing ? num_(existing.uses) + 1 : 1;

  var newRow = {
    id: key,
    key: key,
    name: name,
    brand: brand,
    serving_desc: serving,
    calories: num_(row.calories || row.kcal),
    protein:  num_(row.protein),
    carbs:    num_(row.carbs),
    fat:      num_(row.fat),
    source: row.source || (existing ? existing.source : 'food_log'),
    last_used: todayStr_(),
    uses: uses
  };
  upsertRow_('Food Library', newRow);
  return normalizeFoodRow_(newRow);
}
