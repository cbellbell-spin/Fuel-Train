<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Fuel & Train â€” Personal Tracker</title>
<style>
  :root{
    --bg:#0f172a; /* slate-900 */
    --panel:#111827; /* gray-900 */
    --soft:#1f2937; /* gray-800 */
    --text:#e5e7eb; /* gray-200 */
    --muted:#9ca3af; /* gray-400 */
    --accent:#22c55e; /* green-500 */
    --accent2:#60a5fa; /* blue-400 */
    --warn:#f59e0b; /* amber-500 */
    --danger:#ef4444; /* red-500 */
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Helvetica,Arial,sans-serif;line-height:1.4}
  header{position:sticky;top:0;z-index:5;background:linear-gradient(to bottom, rgba(15,23,42,0.95), rgba(15,23,42,0.75));backdrop-filter: blur(6px);}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  h1{font-size:22px;margin:0 0 6px 0}
  .sub{color:var(--muted);font-size:13px}
  nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  nav button{background:var(--soft);border:1px solid #1f2937;color:var(--text);padding:8px 10px;border-radius:10px;cursor:pointer;font-size:14px}
  nav button.active{border-color:var(--accent);outline:2px solid rgba(34,197,94,0.35)}
  main{padding:16px}
  .panel{background:var(--panel);border:1px solid #1f2937;border-radius:14px;padding:16px;margin-bottom:16px}
  .grid{display:grid;gap:12px}
  .g2{grid-template-columns:repeat(2,1fr)}
  .g3{grid-template-columns:repeat(3,1fr)}
  .g4{grid-template-columns:repeat(4,1fr)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input, select, textarea{width:100%;padding:10px;background:#0b1220;color:var(--text);border:1px solid #1e293b;border-radius:10px}
  textarea{min-height:70px;resize:vertical}
  .btn{background:var(--accent);color:#062; border:none;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
  .btn.secondary{background:var(--soft);color:var(--text);border:1px solid #253045}
  .btn.warn{background:var(--warn);color:#211}
  .btn.danger{background:var(--danger);color:#320}
  .stat{background:var(--soft);padding:12px;border-radius:12px;border:1px solid #253045}
  .stat b{font-size:18px;display:block}
  table{width:100%;border-collapse:separate;border-spacing:0;margin-top:8px}
  th, td{padding:10px;border-bottom:1px solid #1f2a40;text-align:left;font-size:14px}
  th{color:#a3b2c2}
  tr:hover td{background:#0b1220}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #263044;font-size:12px;color:#aab6c8}
  .muted{color:var(--muted)}
  .right{justify-content:flex-end}
  .note{font-size:12px;color:#a0aec0}
  .small{font-size:12px}
  .section-title{font-size:16px;margin:0 0 8px 0}
  .inline-edit{padding:6px 8px;border:1px dashed #334155;border-radius:6px;background:#0b1220}
  .hl{color:var(--accent2)}
  .foot{font-size:12px;color:#93a3b8;margin-top:8px}
  .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;background:#0b1220;border:1px solid #1e293b;border-bottom-width:3px;padding:2px 6px;border-radius:6px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>Fuel & Train</h1>
    <div class="sub">Local, no-cloud tracker for food, exercise, and actionable nutrition guidance. Data lives in your browser. Export anytime.</div>
    <nav id="tabs"></nav>
  </div>
</header>
<main class="wrap">
  <section id="view-dashboard" class="view"></section>
  <section id="view-food" class="view" style="display:none"></section>
  <section id="view-ex" class="view" style="display:none"></section>
  <section id="view-data" class="view" style="display:none"></section>
  <section id="view-settings" class="view" style="display:none"></section>
  <section id="view-suggest" class="view" style="display:none"></section>
</main>

<script>
// ---------- Utilities
const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const todayStr = () => new Date().toISOString().slice(0,10);
const toNum = (v, d=0) => isNaN(parseFloat(v)) ? d : parseFloat(v);
const fmt1 = n => (isFinite(n)?Math.round(n):0);
const uid = () => Math.random().toString(36).slice(2,10) + Date.now().toString(36).slice(-4);

function download(filename, text) {
  const el = document.createElement('a');
  el.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
  el.setAttribute('download', filename);
  el.style.display = 'none';
  document.body.appendChild(el);
  el.click();
  document.body.removeChild(el);
}

function csvEscape(v){
  if(v == null) return '';
  const s = String(v);
  if(/[",\n]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
  return s;
}

function toCSV(rows, headers){
  const head = headers || Object.keys(rows[0]||{});
  const lines = [head.join(',')];
  for(const r of rows){
    lines.push(head.map(h => csvEscape(r[h])).join(','));
  }
  return lines.join('\n');
}

function fromCSV(text){
  // simple CSV parser for our columns
  const lines = text.split(/\r?\n/).filter(Boolean);
  const headers = lines.shift().split(',');
  const out = [];
  for(const line of lines){
    const cells = [];
    let cur = '', inQ = false;
    for(let i=0;i<line.length;i++){
      const ch = line[i];
      if(inQ){
        if(ch === '"' && line[i+1] === '"'){ cur+='"'; i++; }
        else if(ch === '"'){ inQ = false; }
        else { cur += ch; }
      } else {
        if(ch === ','){ cells.push(cur); cur=''; }
        else if(ch === '"'){ inQ = true; }
        else { cur += ch; }
      }
    }
    cells.push(cur);
    const obj = {};
    headers.forEach((h,idx)=> obj[h]=cells[idx] ?? '');
    out.push(obj);
  }
  return {headers, rows: out};
}

// ---------- Data Store
const defaultState = {
  foods: [],
  exercises: [],
  settings: {
    bodyWeightKg: 81.6,  // ~180 lb default
    proteinPerKg: 2.0,
    ree: 1950,          // User baseline REE
    actCalFactor: 0.70, // Apple Watch correction default
    highDayCarb_g_per_kg: 6.0,
    modDayCarb_g_per_kg: 4.0,
    lowDayCarb_g_per_kg: 2.5,
    fat_g_per_kg: 0.8,
    goal: "recomp", // loss, maintain, gain, recomp
    deficit: 400,   // used for loss/recomp
    glp1: false,    // GLP-1 usage flag
    dayType: "moderate", // rest, low, moderate, high
    timezone: Intl.DateTimeFormat().resolvedOptions().timeZone || "local"
  }
};

function loadState(){
  try{
    const raw = localStorage.getItem('ft-app-state');
    if(!raw) return JSON.parse(JSON.stringify(defaultState));
    const parsed = JSON.parse(raw);
    // merge defaults for any new fields
    const merged = Object.assign({}, defaultState, parsed);
    merged.settings = Object.assign({}, defaultState.settings, parsed.settings||{});
    merged.foods = Array.isArray(parsed.foods)? parsed.foods: [];
    merged.exercises = Array.isArray(parsed.exercises)? parsed.exercises: [];
    return merged;
  }catch(e){
    console.warn('loadState failed', e);
    return JSON.parse(JSON.stringify(defaultState));
  }
}
let state = loadState();
function saveState(){ localStorage.setItem('ft-app-state', JSON.stringify(state)); }

// ---------- Tabs
const tabList = [
  {id:'dashboard', label:'Dashboard'},
  {id:'food', label:'Log Food'},
  {id:'ex', label:'Log Exercise'},
  {id:'data', label:'Data & Export'},
  {id:'settings', label:'Settings'},
  {id:'suggest', label:'Suggestions'}
];
function renderTabs(active='dashboard'){
  const nav = $('#tabs');
  nav.innerHTML = '';
  tabList.forEach(t=>{
    const b = document.createElement('button');
    b.textContent = t.label;
    b.className = (t.id===active)?'active':'';
    b.onclick = ()=> switchView(t.id);
    nav.appendChild(b);
  });
}
function switchView(id){
  $$('.view').forEach(v=> v.style.display = 'none');
  $(`#view-${id}`).style.display = '';
  renderTabs(id);
  if(id==='dashboard') renderDashboard();
  if(id==='food') renderFood();
  if(id==='ex') renderExercise();
  if(id==='data') renderData();
  if(id==='settings') renderSettings();
  if(id==='suggest') renderSuggest();
}

// ---------- Dashboard
function calcTotals(dateStr){
  const foods = state.foods.filter(f=> f.date === dateStr);
  const exs = state.exercises.filter(e=> e.date === dateStr);
  const calFood = foods.reduce((a,b)=> a + toNum(b.calories), 0);
  const p = foods.reduce((a,b)=> a + toNum(b.protein), 0);
  const c = foods.reduce((a,b)=> a + toNum(b.carbs), 0);
  const fat = foods.reduce((a,b)=> a + toNum(b.fat), 0);
  const active = exs.reduce((a,b)=> a + correctedActiveCalories(b), 0);
  return {calFood, p, c, fat, active};
}

function correctedActiveCalories(e){
  // Option 1: use device calories if provided, scaled by factor
  const factor = toNum(state.settings.actCalFactor, 0.7);
  const device = toNum(e.deviceCalories, 0);
  if(device>0) return device * factor;

  // Option 2: estimate by duration & intensity (crude MET-based)
  const durH = toNum(e.durationMin,0) / 60;
  const met = {rest:1.2, low:4.0, moderate:7.0, high:10.0}[e.intensity||'moderate'];
  // kcal = MET * kg * hours
  const kcal = met * toNum(state.settings.bodyWeightKg,80) * durH;
  return kcal;
}

function renderDashboard(){
  const el = $('#view-dashboard');
  const d = todayStr();
  const totals = calcTotals(d);
  const tdee = toNum(state.settings.ree,1950) + totals.active;
  const goal = state.settings.goal;
  const deficit = toNum(state.settings.deficit, 400);
  let targetIntake = tdee;
  if(goal==='loss') targetIntake = tdee - deficit;
  if(goal==='recomp') targetIntake = tdee - Math.min(deficit, 300);
  if(goal==='gain') targetIntake = tdee + 200;
  const balance = targetIntake - totals.calFood;

  el.innerHTML = `
    <div class="panel">
      <div class="row">
        <div class="stat"><b>${fmt1(totals.calFood)}</b><div class="muted small">Calories eaten today</div></div>
        <div class="stat"><b>${fmt1(totals.p)} g</b><div class="muted small">Protein</div></div>
        <div class="stat"><b>${fmt1(totals.c)} g</b><div class="muted small">Carbs</div></div>
        <div class="stat"><b>${fmt1(totals.fat)} g</b><div class="muted small">Fat</div></div>
        <div class="stat"><b>${fmt1(totals.active)}</b><div class="muted small">Corrected active kcals</div></div>
        <div class="stat"><b>${fmt1(tdee)}</b><div class="muted small">TDEE est.</div></div>
        <div class="stat"><b>${fmt1(targetIntake)}</b><div class="muted small">Target intake</div></div>
        <div class="stat"><b class="${balance>=0?'hl':''}">${fmt1(balance)}</b><div class="muted small">Remaining vs target</div></div>
      </div>
      <div class="foot">Activity calories are corrected using factor <span class="kbd">${state.settings.actCalFactor}</span>. Edit in Settings.</div>
    </div>

    <div class="panel">
      <h3 class="section-title">Today â€” Quick add</h3>
      <div class="grid g4">
        <div>
          <label>Food item</label>
          <input id="qa-food" placeholder="e.g., Greek yogurt with berries">
        </div>
        <div>
          <label>Calories</label>
          <input id="qa-cal" type="number" placeholder="kcal">
        </div>
        <div>
          <label>Protein (g)</label>
          <input id="qa-prot" type="number" step="0.1">
        </div>
        <div>
          <label>Carbs (g)</label>
          <input id="qa-carb" type="number" step="0.1">
        </div>
        <div>
          <label>Fat (g)</label>
          <input id="qa-fat" type="number" step="0.1">
        </div>
        <div class="row right">
          <button class="btn" id="qa-add">Add food</button>
          <button class="btn secondary" onclick="switchView('food')">Open Food Log</button>
        </div>
      </div>
    </div>
  `;
  $('#qa-add').onclick = ()=>{
    const food = {
      id: uid(),
      date: todayStr(),
      time: new Date().toTimeString().slice(0,5),
      item: $('#qa-food').value.trim() || 'Food',
      calories: toNum($('#qa-cal').value,0),
      protein: toNum($('#qa-prot').value,0),
      carbs: toNum($('#qa-carb').value,0),
      fat: toNum($('#qa-fat').value,0),
      notes: ''
    };
    state.foods.push(food); saveState(); renderDashboard();
  };
}

// ---------- Food Log
function renderFood(){
  const el = $('#view-food');
  el.innerHTML = `
    <div class="panel">
      <h3 class="section-title">Add Food</h3>
      <div class="grid g4">
        <div><label>Date</label><input id="f-date" type="date" value="${todayStr()}"></div>
        <div><label>Time</label><input id="f-time" type="time" value="${new Date().toTimeString().slice(0,5)}"></div>
        <div class="g3" style="grid-column: span 2">
          <div><label>Item</label><input id="f-item" placeholder="What did you eat?"></div>
          <div><label>Calories</label><input id="f-cal" type="number" step="1"></div>
          <div><label>Protein (g)</label><input id="f-prot" type="number" step="0.1"></div>
          <div><label>Carbs (g)</label><input id="f-carb" type="number" step="0.1"></div>
          <div><label>Fat (g)</label><input id="f-fat" type="number" step="0.1"></div>
        </div>
        <div style="grid-column: span 4"><label>Notes</label><textarea id="f-notes" placeholder="Context, hunger, satiety, etc."></textarea></div>
      </div>
      <div class="row right">
        <button class="btn" id="f-add">Add</button>
      </div>
    </div>

    <div class="panel">
      <h3 class="section-title">Food Entries</h3>
      <div class="row">
        <label>Filter date</label>
        <input id="f-filter" type="date" value="${todayStr()}" style="max-width:200px">
        <button class="btn secondary" id="f-clear-filter">All</button>
      </div>
      <div id="f-table"></div>
    </div>
  `;
  $('#f-add').onclick = ()=>{
    const food = {
      id: uid(),
      date: $('#f-date').value || todayStr(),
      time: $('#f-time').value || '00:00',
      item: $('#f-item').value.trim() || 'Food',
      calories: toNum($('#f-cal').value,0),
      protein: toNum($('#f-prot').value,0),
      carbs: toNum($('#f-carb').value,0),
      fat: toNum($('#f-fat').value,0),
      notes: $('#f-notes').value.trim()
    };
    state.foods.push(food); saveState(); renderFood();
  };
  $('#f-clear-filter').onclick = ()=>{ $('#f-filter').value=''; renderFoodTable(); };
  $('#f-filter').onchange = renderFoodTable;
  renderFoodTable();
}

function renderFoodTable(){
  const container = $('#f-table');
  const filter = $('#f-filter').value;
  const rows = state.foods.filter(r=> !filter || r.date===filter);
  const total = rows.reduce((a,b)=>{
    a.cal+=toNum(b.calories); a.p+=toNum(b.protein); a.c+=toNum(b.carbs); a.f+=toNum(b.fat); return a;
  }, {cal:0,p:0,c:0,f:0});
  container.innerHTML = `
    <div class="row">
      <div class="pill">Entries: ${rows.length}</div>
      <div class="pill">Calories: ${fmt1(total.cal)}</div>
      <div class="pill">Protein: ${fmt1(total.p)}g</div>
      <div class="pill">Carbs: ${fmt1(total.c)}g</div>
      <div class="pill">Fat: ${fmt1(total.f)}g</div>
    </div>
    <table>
      <thead><tr>
        <th>Date</th><th>Time</th><th>Item</th><th>Cal</th><th>P</th><th>C</th><th>F</th><th>Notes</th><th></th>
      </tr></thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            ${['date','time','item','calories','protein','carbs','fat','notes'].map(k=>`<td contenteditable class="inline-edit" data-id="${r.id}" data-field="${k}">${r[k] ?? ''}</td>`).join('')}
            <td><button class="btn danger small" data-del="${r.id}">Del</button></td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    <div class="foot small">Click any cell to edit. Changes save automatically when you blur the cell.</div>
  `;
  // bind edits
  $$('#f-table [contenteditable]').forEach(cell=>{
    cell.addEventListener('blur', e=>{
      const id = cell.dataset.id, field = cell.dataset.field;
      const row = state.foods.find(x=>x.id===id); if(!row) return;
      row[field] = ['calories','protein','carbs','fat'].includes(field) ? toNum(cell.textContent.trim(),0) : cell.textContent.trim();
      saveState();
      renderFoodTable();
    });
  });
  // bind deletes
  $$('#f-table [data-del]').forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute('data-del');
      state.foods = state.foods.filter(x=> x.id!==id); saveState(); renderFoodTable();
    };
  });
}

// ---------- Exercise
function renderExercise(){
  const el = $('#view-ex');
  el.innerHTML = `
    <div class="panel">
      <h3 class="section-title">Add Exercise</h3>
      <div class="grid g4">
        <div><label>Date</label><input id="e-date" type="date" value="${todayStr()}"></div>
        <div><label>Type</label>
          <select id="e-type">
            <option>Cycling - Road</option>
            <option>Cycling - MTB</option>
            <option>Cycling - Gravel</option>
            <option>Run</option>
            <option>Walk</option>
            <option>Strength</option>
            <option>Other</option>
          </select>
        </div>
        <div><label>Duration (min)</label><input id="e-dur" type="number"></div>
        <div><label>Intensity</label>
          <select id="e-int">
            <option value="rest">Rest</option>
            <option value="low">Low</option>
            <option value="moderate" selected>Moderate</option>
            <option value="high">High</option>
          </select>
        </div>
        <div><label>Device calories (kcal) <span class="muted small">(Apple/WHOOP/etc.)</span></label><input id="e-dev" type="number"></div>
        <div><label>Avg HR</label><input id="e-hr" type="number"></div>
        <div><label>RPE (1-10)</label><input id="e-rpe" type="number"></div>
        <div><label>Notes</label><input id="e-notes" placeholder="Power, elevation, etc."></div>
      </div>
      <div class="row right">
        <button class="btn" id="e-add">Add</button>
      </div>
    </div>

    <div class="panel">
      <h3 class="section-title">Exercise Entries</h3>
      <div class="row">
        <label>Filter date</label>
        <input id="e-filter" type="date" value="${todayStr()}" style="max-width:200px">
        <button class="btn secondary" id="e-clear">All</button>
      </div>
      <div id="e-table"></div>
    </div>
  `;
  $('#e-add').onclick = ()=>{
    const e = {
      id: uid(),
      date: $('#e-date').value || todayStr(),
      type: $('#e-type').value,
      durationMin: toNum($('#e-dur').value,0),
      intensity: $('#e-int').value,
      deviceCalories: toNum($('#e-dev').value,0),
      avgHR: toNum($('#e-hr').value,0),
      rpe: toNum($('#e-rpe').value,0),
      notes: $('#e-notes').value.trim()
    };
    state.exercises.push(e); saveState(); renderExercise();
  };
  $('#e-clear').onclick = ()=>{ $('#e-filter').value=''; renderExerciseTable(); };
  $('#e-filter').onchange = renderExerciseTable;
  renderExerciseTable();
}

function renderExerciseTable(){
  const container = $('#e-table');
  const filter = $('#e-filter').value;
  const rows = state.exercises.filter(r=> !filter || r.date===filter);
  const totalActive = rows.reduce((a,b)=> a + correctedActiveCalories(b), 0);
  container.innerHTML = `
    <div class="row">
      <div class="pill">Entries: ${rows.length}</div>
      <div class="pill">Corrected active kcals: ${fmt1(totalActive)}</div>
    </div>
    <table>
      <thead><tr>
        <th>Date</th><th>Type</th><th>Dur</th><th>Int</th><th>Device kcal</th><th>Avg HR</th><th>RPE</th><th>Notes</th><th>Adj kcal</th><th></th>
      </tr></thead>
      <tbody>
        ${rows.map(r=>`
          <tr>
            ${['date','type','durationMin','intensity','deviceCalories','avgHR','rpe','notes'].map(k=>`<td contenteditable class="inline-edit" data-exid="${r.id}" data-field="${k}">${r[k] ?? ''}</td>`).join('')}
            <td>${fmt1(correctedActiveCalories(r))}</td>
            <td><button class="btn danger small" data-del="${r.id}">Del</button></td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    <div class="foot small">Edit cells directly. Activity correction factor from Settings is applied.</div>
  `;
  $$('#e-table [contenteditable]').forEach(cell=>{
    cell.addEventListener('blur', e=>{
      const id = cell.dataset.exid, field = cell.dataset.field;
      const row = state.exercises.find(x=>x.id===id); if(!row) return;
      const numeric = ['durationMin','deviceCalories','avgHR','rpe'].includes(field);
      row[field] = numeric ? toNum(cell.textContent.trim(),0) : cell.textContent.trim();
      saveState(); renderExerciseTable();
    });
  });
  $$('#e-table [data-del]').forEach(btn=>{
    btn.onclick = ()=>{
      const id = btn.getAttribute('data-del');
      state.exercises = state.exercises.filter(x=> x.id!==id); saveState(); renderExerciseTable();
    };
  });
}

// ---------- Data & Export
function renderData(){
  const el = $('#view-data');
  const foodsCSV = toCSV(state.foods, ['id','date','time','item','calories','protein','carbs','fat','notes']);
  const exCSV = toCSV(state.exercises, ['id','date','type','durationMin','intensity','deviceCalories','avgHR','rpe','notes']);

  el.innerHTML = `
    <div class="panel">
      <h3 class="section-title">Export</h3>
      <div class="row">
        <button class="btn" id="exp-food">Export Food CSV</button>
        <button class="btn" id="exp-ex">Export Exercise CSV</button>
        <button class="btn secondary" id="exp-json">Export All JSON</button>
      </div>
      <div class="foot small">CSV opens in your spreadsheet app. JSON is a full backup you can re-import later.</div>
    </div>

    <div class="panel">
      <h3 class="section-title">Import</h3>
      <div class="row">
        <input type="file" id="imp-file" accept=".csv,.json" />
        <select id="imp-target">
          <option value="auto">Auto-detect</option>
          <option value="foods">Foods</option>
          <option value="exercises">Exercises</option>
          <option value="state">Full state (JSON)</option>
        </select>
        <button class="btn" id="imp-run">Import</button>
      </div>
      <div class="foot small">On CSV import, columns should match the exported headers. JSON import replaces the entire state.</div>
    </div>

    <div class="panel">
      <h3 class="section-title">Raw Data Preview</h3>
      <details open>
        <summary>Foods (${state.foods.length})</summary>
        <pre class="small" style="overflow:auto; max-height:220px">${foodsCSV.replace(/</g,'&lt;')}</pre>
      </details>
      <details>
        <summary>Exercises (${state.exercises.length})</summary>
        <pre class="small" style="overflow:auto; max-height:220px">${exCSV.replace(/</g,'&lt;')}</pre>
      </details>
    </div>
  `;
  $('#exp-food').onclick = ()=> download(`foods_${new Date().toISOString().slice(0,10)}.csv`, foodsCSV);
  $('#exp-ex').onclick = ()=> download(`exercises_${new Date().toISOString().slice(0,10)}.csv`, exCSV);
  $('#exp-json').onclick = ()=> download(`ft_backup_${Date.now()}.json`, JSON.stringify(state,null,2));
  $('#imp-run').onclick = ()=>{
    const file = $('#imp-file').files[0];
    if(!file){ alert('Pick a file first.'); return; }
    const reader = new FileReader();
    reader.onload = ()=>{
      const text = reader.result;
      const target = $('#imp-target').value;
      try{
        if(file.name.endsWith('.json') || target==='state'){
          const obj = JSON.parse(text);
          if(target==='state'){ state = obj; saveState(); alert('Imported full state.'); location.reload(); return; }
          // else fallthrough
        }
        if(file.name.endsWith('.csv')){
          const parsed = fromCSV(text);
          if(target==='foods' || (target==='auto' && parsed.headers.includes('item') && parsed.headers.includes('calories'))){
            state.foods = parsed.rows.map(r=> ({
              id: r.id || uid(),
              date: r.date || todayStr(),
              time: r.time || '00:00',
              item: r.item || '',
              calories: toNum(r.calories,0),
              protein: toNum(r.protein,0),
              carbs: toNum(r.carbs,0),
              fat: toNum(r.fat,0),
              notes: r.notes||''
            }));
            saveState(); alert('Imported foods.'); renderData(); return;
          }
          if(target==='exercises' || (target==='auto' && parsed.headers.includes('durationMin') && parsed.headers.includes('intensity'))){
            state.exercises = parsed.rows.map(r=> ({
              id: r.id || uid(),
              date: r.date || todayStr(),
              type: r.type || 'Other',
              durationMin: toNum(r.durationMin,0),
              intensity: r.intensity || 'moderate',
              deviceCalories: toNum(r.deviceCalories,0),
              avgHR: toNum(r.avgHR,0),
              rpe: toNum(r.rpe,0),
              notes: r.notes || ''
            }));
            saveState(); alert('Imported exercises.'); renderData(); return;
          }
          alert('CSV columns not recognized. Check headers.');
        } else if(file.name.endsWith('.json')){
          const obj = JSON.parse(text);
          state = Object.assign({}, state, obj);
          saveState(); alert('Imported JSON.'); location.reload();
        } else {
          alert('Unsupported file.');
        }
      }catch(e){ console.error(e); alert('Import failed: '+ e.message); }
    };
    reader.readAsText(file);
  };
}

// ---------- Settings
function renderSettings(){
  const s = state.settings;
  const el = $('#view-settings');
  el.innerHTML = `
    <div class="panel">
      <h3 class="section-title">Core Settings</h3>
      <div class="grid g4">
        <div><label>Body weight (kg)</label><input id="s-bw" type="number" step="0.1" value="${s.bodyWeightKg}"></div>
        <div><label>Protein target (g/kg)</label><input id="s-ppk" type="number" step="0.1" value="${s.proteinPerKg}"></div>
        <div><label>Baseline REE (kcal)</label><input id="s-ree" type="number" value="${s.ree}"></div>
        <div><label>Activity correction factor</label><input id="s-fact" type="number" step="0.01" value="${s.actCalFactor}"></div>
        <div><label>Day type</label>
          <select id="s-day">
            <option value="rest" ${s.dayType==='rest'?'selected':''}>Rest</option>
            <option value="low" ${s.dayType==='low'?'selected':''}>Low</option>
            <option value="moderate" ${s.dayType==='moderate'?'selected':''}>Moderate</option>
            <option value="high" ${s.dayType==='high'?'selected':''}>High</option>
          </select>
        </div>
        <div><label>Goal</label>
          <select id="s-goal">
            <option value="loss" ${s.goal==='loss'?'selected':''}>Fat loss</option>
            <option value="maintain" ${s.goal==='maintain'?'selected':''}>Maintain</option>
            <option value="gain" ${s.goal==='gain'?'selected':''}>Gain</option>
            <option value="recomp" ${s.goal==='recomp'?'selected':''}>Recomp</option>
          </select>
        </div>
        <div><label>Deficit (kcal when loss/recomp)</label><input id="s-def" type="number" value="${s.deficit}"></div>
        <div><label>GLP-1 user</label>
          <select id="s-glp1">
            <option value="false" ${!s.glp1?'selected':''}>No</option>
            <option value="true" ${s.glp1?'selected':''}>Yes</option>
          </select>
        </div>
      </div>
    </div>
    <div class="panel">
      <h3 class="section-title">Macro Formula</h3>
      <div class="grid g4">
        <div><label>High day carbs (g/kg)</label><input id="s-ch-high" type="number" step="0.1" value="${s.highDayCarb_g_per_kg}"></div>
        <div><label>Moderate day carbs (g/kg)</label><input id="s-ch-mod" type="number" step="0.1" value="${s.modDayCarb_g_per_kg}"></div>
        <div><label>Low day carbs (g/kg)</label><input id="s-ch-low" type="number" step="0.1" value="${s.lowDayCarb_g_per_kg}"></div>
        <div><label>Fat baseline (g/kg)</label><input id="s-fatkg" type="number" step="0.1" value="${s.fat_g_per_kg}"></div>
      </div>
      <div class="row right">
        <button class="btn" id="s-save">Save settings</button>
      </div>
      <div class="foot small">Protein floors at weight Ã— protein g/kg. Carbs vary by day type; fats fill remaining calories after protein + carbs.</div>
    </div>
  `;
  $('#s-save').onclick = ()=>{
    s.bodyWeightKg = toNum($('#s-bw').value, s.bodyWeightKg);
    s.proteinPerKg = toNum($('#s-ppk').value, s.proteinPerKg);
    s.ree = toNum($('#s-ree').value, s.ree);
    s.actCalFactor = toNum($('#s-fact').value, s.actCalFactor);
    s.dayType = $('#s-day').value;
    s.goal = $('#s-goal').value;
    s.deficit = toNum($('#s-def').value, s.deficit);
    s.glp1 = $('#s-glp1').value === 'true';
    s.highDayCarb_g_per_kg = toNum($('#s-ch-high').value, s.highDayCarb_g_per_kg);
    s.modDayCarb_g_per_kg = toNum($('#s-ch-mod').value, s.modDayCarb_g_per_kg);
    s.lowDayCarb_g_per_kg = toNum($('#s-ch-low').value, s.lowDayCarb_g_per_kg);
    s.fat_g_per_kg = toNum($('#s-fatkg').value, s.fat_g_per_kg);
    saveState();
    alert('Saved.');
  };
}

// ---------- Suggestions
function macroPlan(){
  const s = state.settings;
  const bw = toNum(s.bodyWeightKg,80);
  const protein = Math.max(bw * toNum(s.proteinPerKg, 2.0), bw*1.6);
  let carbsPerKg = s.modDayCarb_g_per_kg;
  if(s.dayType==='high') carbsPerKg = s.highDayCarb_g_per_kg;
  if(s.dayType==='low') carbsPerKg = s.lowDayCarb_g_per_kg;
  if(s.dayType==='rest') carbsPerKg = Math.min(2.0, s.lowDayCarb_g_per_kg);
  const carbs = bw * carbsPerKg;
  const fatsMin = bw * toNum(s.fat_g_per_kg, 0.8);

  // calories for P & C
  const kcFromP = protein * 4;
  const kcFromC = carbs * 4;

  // estimate active kcals for today
  const actToday = state.exercises.filter(e=> e.date===todayStr()).reduce((a,b)=> a + correctedActiveCalories(b), 0);
  const tdee = toNum(s.ree,1950) + actToday;

  // goal adj
  let target = tdee;
  if(s.goal==='loss') target -= toNum(s.deficit,400);
  if(s.goal==='recomp') target -= Math.min(toNum(s.deficit,400), 300);
  if(s.goal==='gain') target += 200;

  const kcalRemainingForFat = target - kcFromP - kcFromC;
  const fats = Math.max(fatsMin, kcalRemainingForFat/9);

  return {protein, carbs, fats, kcalsTarget: target, tdee, actToday};
}

function renderSuggest(){
  const el = $('#view-suggest');
  const mp = macroPlan();
  const eaten = state.foods.filter(f=> f.date===todayStr()).reduce((acc,f)=>{
    acc.kcal += toNum(f.calories,0);
    acc.p += toNum(f.protein,0);
    acc.c += toNum(f.carbs,0);
    acc.f += toNum(f.fat,0);
    return acc;
  }, {kcal:0,p:0,c:0,f:0});

  const left = {
    kcal: mp.kcalsTarget - eaten.kcal,
    p: mp.protein - eaten.p,
    c: mp.carbs - eaten.c,
    f: mp.fats - eaten.f
  };

  // simple fueling timing heuristic (Hexis-inspired)
  const dayType = state.settings.dayType;
  let timing = [];
  if(dayType==='high'){
    timing = [
      "Pre-ride 2â€“3h: 1â€“1.5 g/kg carbs, lean protein, low fat",
      "During: 60â€“90 g carbs/h for rides >90 min, sodium 500â€“800 mg/h",
      "Post 0â€“2h: 0.6â€“1.0 g/kg carbs + 30â€“50 g protein"
    ];
  } else if(dayType==='moderate'){
    timing = [
      "Pre-ride 1â€“2h: ~0.8 g/kg carbs + 25â€“35 g protein",
      "During: 30â€“60 g carbs/h if >60 min",
      "Post: 0.4â€“0.8 g/kg carbs + 30â€“40 g protein"
    ];
  } else {
    timing = [
      "Focus on protein-forward meals and veg",
      "Carbs mostly around training windows",
      "Keep hydration and electrolytes steady"
    ];
  }

  const glp1Tips = state.settings.glp1 ? [
    "Smaller, more frequent meals to limit GI issues",
    "Front-load protein earlier in the day if appetite is higher",
    "Hydration first on waking; wait 10â€“15 min before first food",
    "Keep ultra-fatty foods moderate if nausea-prone"
  ] : [];

  el.innerHTML = `
    <div class="panel">
      <h3 class="section-title">Today at a glance</h3>
      <div class="row">
        <div class="stat"><b>${fmt1(mp.kcalsTarget)}</b><div class="muted small">Target kcal</div></div>
        <div class="stat"><b>${fmt1(mp.protein)} g</b><div class="muted small">Protein target</div></div>
        <div class="stat"><b>${fmt1(mp.carbs)} g</b><div class="muted small">Carb target (${state.settings.dayType})</div></div>
        <div class="stat"><b>${fmt1(mp.fats)} g</b><div class="muted small">Fat target</div></div>
      </div>
      <div class="row">
        <div class="pill">Eaten: ${fmt1(eaten.kcal)} kcal, ${fmt1(eaten.p)}P/${fmt1(eaten.c)}C/${fmt1(eaten.f)}F</div>
        <div class="pill">Remaining: ${fmt1(left.kcal)} kcal, ${fmt1(left.p)}P/${fmt1(left.c)}C/${fmt1(left.f)}F</div>
      </div>
      <div class="foot small">Assumptions: REE ${state.settings.ree}, activity factor ${state.settings.actCalFactor}, protein ${state.settings.proteinPerKg} g/kg. Adjust in Settings.</div>
    </div>

    <div class="panel">
      <h3 class="section-title">Actionable suggestions</h3>
      <ul class="small">
        <li><b>Fueling timing:</b> ${timing.join(' â€¢ ')}</li>
        <li><b>Next meal idea:</b> high-protein bowl with grains and veg. Example: farro 75 g cooked, grilled chicken 140 g, roasted veg, olive oil 10 g, yogurt herb sauce. Roughly 620 kcal, 45P/55C/20F.</li>
        <li><b>Protein floor:</b> aim to clear ${fmt1(mp.protein)} g by dinner. If behind, add a 30â€“40 g protein snack.</li>
        ${state.settings.glp1 ? `<li><b>GLP-1 adjustments:</b> ${glp1Tips.join(' â€¢ ')}</li>` : ''}
        <li><b>Electrolytes:</b> 500â€“800 mg sodium per training hour if sweating heavily. Use your usual correction factor for active kcals.</li>
      </ul>
      <div class="foot small">These are heuristics based on endurance nutrition practice. Customize macro formulas in Settings.</div>
    </div>
  `;
}

// ---------- Init
renderTabs();
switchView('dashboard');
</script>
</body>
</html>
